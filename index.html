<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset="utf-8">
    
    <title>Notes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="website">
<meta property="og:title" content="Notes">
<meta property="og:url" content="http://funkygao.github.io/index.html">
<meta property="og:site_name" content="Notes">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Notes">
    

    
        <link rel="alternate" href="/" title="Notes" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                
                <span class="site-title">Notes</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/images/avatar.jpeg" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/images/avatar.jpeg" />
            <h2 id="name">Funky Gao</h2>
            <h3 id="title">Explore, Solve problems</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Beijing, China</span>
            <a id="follow" target="_blank" href="https://github.com/funkygao/">FOLLOW</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                97
                <span>posts</span>
            </div>
            <div class="article-info-block">
                10
                <span>tags</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="http://github.com/funkygao" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="twitter" class=tooltip>
                            <i class="fa fa-twitter"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="facebook" class=tooltip>
                            <i class="fa fa-facebook"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="dribbble" class=tooltip>
                            <i class="fa fa-dribbble"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="rss" class=tooltip>
                            <i class="fa fa-rss"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main">
    <article id="post-BigData-related" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2018/01/18/BigData-related/">BigData related</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2018/01/18/BigData-related/">
            <time datetime="2018-01-18T00:44:54.000Z" itemprop="datePublished">2018-01-18</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/architecture/">architecture</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="Open-Source"><a href="#Open-Source" class="headerlink" title="Open Source"></a>Open Source</h2><ul>
<li>HDFS/Kudu</li>
<li>Cassandra/Hbase</li>
<li>SQL-on-hadoop<ul>
<li>Hive(on MR)<br>SQL解析，物理执行是通过生成map/reduce job完成的</li>
<li>ad-hoc query to group,filter,aggregate data<ul>
<li>Presto<br>Facebook开发的Hive，但后来放弃了，转而开发了Presto。<br>一个Presto query可以跨越多个数据源</li>
<li>Impala(Dremel的启发下开发的C++)<br>Cloudera虽然支持Hive，但自己开发了Impala。底层HDFS存储Parquet，建议用Kudu替换HDFS。<br>Kudu是columnar datastore，但不提供SQL解析执行，SQL部分由Impala完成。<br>定位于短查询，如果节点失效，查询会重头开始，没有fault-tolerant。</li>
<li>SparkSQL(Shark)<br>Shark最初是在Hive的代码基础上进行的，后来重新实现了：SparkSQL</li>
<li>Stinger/Tez</li>
<li>Hive-on-Spark/Hive-on-Tez<br>Hortonworks</li>
<li>Google Dremel<br>只能查询一个table，不能join<ul>
<li>Apache Drill</li>
<li>Druid</li>
<li>IBM BigSQL</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Spark/Storm/Flink</li>
<li>mesos/yarn/k8s</li>
<li>Apache Tez<br>一个Hadoop DAG技术框架，解决MR的问题一个替代方案，依赖YARN</li>
<li>tools<ul>
<li>sqoop</li>
</ul>
</li>
</ul>
<h2 id="Apache-Kylin"><a href="#Apache-Kylin" class="headerlink" title="Apache Kylin"></a>Apache Kylin</h2><p>MOLAP engine built on Hive</p>
<h3 id="OLAP"><a href="#OLAP" class="headerlink" title="OLAP"></a>OLAP</h3><p>Slice/Dice/Drill-down/Roll-up/Pivot</p>
<ul>
<li>ROLAP</li>
<li>MOLAP</li>
<li>HOLAP</li>
</ul>
<h3 id="Cube"><a href="#Cube" class="headerlink" title="Cube"></a>Cube</h3><p>Cube   = all combination of dimensions<br>Cuboid = one combination of dimensions(all cuboids)</p>
<p>Cube is immutable!</p>
<ul>
<li>One fact table<br>has ever growing records</li>
<li>A few dimension tables<br>relatively static, like users and products</li>
<li>Hive tables must be synced into Kylin first</li>
<li>Measures<ul>
<li>sum</li>
<li>count</li>
<li>distinct count(HyperLogLog)</li>
<li>avg</li>
<li>max</li>
<li>min</li>
</ul>
</li>
<li>Incremental Build<ul>
<li>Segment<ul>
<li>与ES的实现思路类似<ul>
<li>query时aggregate</li>
<li>merge small cubes into a larger one</li>
</ul>
</li>
<li>cube is immutable</li>
</ul>
</li>
<li>只支持按时间维度</li>
</ul>
</li>
</ul>
<h3 id="Visualization"><a href="#Visualization" class="headerlink" title="Visualization"></a>Visualization</h3><ul>
<li>saiku</li>
<li>Caravel</li>
<li>Zeppelin</li>
<li>superset</li>
<li>Cboard</li>
</ul>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://funkygao.github.io/2018/01/18/BigData-related/" data-id="cjcxbtvad0009005bx4kh4ew0" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://funkygao.github.io/2018/01/18/BigData-related/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://funkygao.github.io/2018/01/18/BigData-related/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-Misc" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/12/14/Misc/">知名公司功能模块的实现笔记</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/12/14/Misc/">
            <time datetime="2017-12-14T02:06:48.000Z" itemprop="datePublished">2017-12-14</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/algorithm/">algorithm</a>, <a class="tag-link" href="/tags/architecture/">architecture</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="Storage"><a href="#Storage" class="headerlink" title="Storage"></a>Storage</h2><h3 id="微信支付的交易记录"><a href="#微信支付的交易记录" class="headerlink" title="微信支付的交易记录"></a>微信支付的交易记录</h3><p>之前kv，每个用户一个key(相当于redis list)，这样问题是：</p>
<ul>
<li>value会大</li>
<li>无法根据条件filter value</li>
</ul>
<p>改进后：<br>没有用户多个value，其中1个root value，保存metadata，其他value为data<br>多value解决了以前单value大的问题，但：</p>
<ul>
<li>多了一次请求<br>先root，再value</li>
<li>root成为新瓶颈<ul>
<li>可以把root也变成一个link list<br>按照时间倒排，新的是head，老的是tail</li>
<li>但越以前的数据，越慢</li>
</ul>
</li>
</ul>
<h2 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h2><h3 id="biparties-graph-二部图-二分图"><a href="#biparties-graph-二部图-二分图" class="headerlink" title="biparties graph(二部图/二分图)"></a>biparties graph(二部图/二分图)</h3><p>对多种查询条件进行归并缓存，提高缓存命中率</p>
<p>查询条件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(row1, row5) =&gt; (field3, field7)</div><div class="line">(row2) =&gt; (field2, field4)</div><div class="line">(row3) =&gt; (field3, field5)</div><div class="line">(row4, row6) =&gt; (field1, field4, field8)</div></pre></td></tr></table></figure>
<p>利用二部图把图切分，把零散查询归并为少数集中的查询</p>
<h2 id="M-Cloud-Design-Pattern"><a href="#M-Cloud-Design-Pattern" class="headerlink" title="M$ Cloud Design Pattern"></a>M$ Cloud Design Pattern</h2><ul>
<li>cache-aside</li>
<li>ciruit breaker</li>
<li>compensating transation</li>
<li>competing consumers</li>
<li>CQRS</li>
<li>event sourcing</li>
<li>external configuration store</li>
<li>federated identity</li>
<li>gatekeeper(gateway)</li>
<li>health endpoint monitoring</li>
<li>index table</li>
<li>lead election</li>
<li>materialized view</li>
<li>pipes and filters</li>
<li>priority queue</li>
<li>queue-based load leveling</li>
<li>retry</li>
<li>runtime reconfiguration</li>
<li>scheduler agent supervisor</li>
<li>sharding</li>
<li>static content hosting</li>
<li>throttling</li>
<li>valet key</li>
</ul>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://funkygao.github.io/2017/12/14/Misc/" data-id="cjcxbtvbh001n005bt2n9tlu6" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://funkygao.github.io/2017/12/14/Misc/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://funkygao.github.io/2017/12/14/Misc/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-OtterTune" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/12/11/OtterTune/">OtterTune</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/12/11/OtterTune/">
            <time datetime="2017-12-11T01:28:11.000Z" itemprop="datePublished">2017-12-11</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/algorithm/">algorithm</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="DB-tuning问题"><a href="#DB-tuning问题" class="headerlink" title="DB tuning问题"></a>DB tuning问题</h2><p>传统方法：DBA把生产库copy到另外一个机器，回放sql，根据metrics尝试调节某一个参数看效果，再尝试多个</p>
<ul>
<li>数据库的调优参数过多，通常都是数百个，而且新的版本会增加更多参数</li>
<li>同一个db的参数之间是互相依赖的</li>
<li>依赖于运行环境<br>例如，增加innobuffer，在某些条件下是正回馈，但如果物理机内存开始swap，增加它会起副作用</li>
<li>跟业务数据有关</li>
</ul>
<h2 id="OtterTune解决办法"><a href="#OtterTune解决办法" class="headerlink" title="OtterTune解决办法"></a>OtterTune解决办法</h2><p>通过controller收集数据库的参数和负载metrics以及hardware profile，定期向中央报告。<br>分析系统从中央取得原始数据，进行分析，提供参数配置建议，生效后，持续分析比较，找出合适的参数配置</p>
<h3 id="target-workload"><a href="#target-workload" class="headerlink" title="target workload"></a>target workload</h3><ul>
<li>latency</li>
<li>throughput</li>
</ul>
<h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><p>就是agent,定期把通过配置文件配置的数据库实例的paramters &amp; metrics通过HTTP POST以JSON格式上传<br>同时，它是trial and error的执行者，对参数不断的尝试取得样本数据，它必须有修改数据库参数权限，甚至restart db</p>
<h4 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h4><ul>
<li>SELECT version()</li>
<li>parameters<br>SHOW ALL</li>
<li>metrics<ul>
<li>select * from pg_stat_archiver/pg_stat_bgwriter/pg_stat_database/pg_statio_user_indexes/…</li>
</ul>
</li>
</ul>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><ul>
<li>通过factor analysis(FA)对收集来的metrics进行降维<br>例如，read_in_bytes/read_in_kbytes</li>
<li>通过k-means对metrics进行聚类</li>
<li>通过Lasso线性回归，来发现哪些参数对target workload有重大影响</li>
<li>workload mapping<br>通过Euclidean计算目标workload与历史采样数据的相似度，找出最相似的</li>
<li>推荐配置<br>通过GaussianProcess(GP)回归进行训练</li>
<li>controller接受推荐的配置apply on DB，并收集新的数据</li>
</ul>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="http://db.cs.cmu.edu/papers/2017/p1009-van-aken.pdf" target="_blank" rel="external">http://db.cs.cmu.edu/papers/2017/p1009-van-aken.pdf</a><br><a href="https://github.com/cmu-db/ottertune" target="_blank" rel="external">https://github.com/cmu-db/ottertune</a></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://funkygao.github.io/2017/12/11/OtterTune/" data-id="cjcxbtvbq001x005bclv5g71a" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://funkygao.github.io/2017/12/11/OtterTune/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://funkygao.github.io/2017/12/11/OtterTune/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-TimescaleDB" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/09/28/TimescaleDB/">TimescaleDB</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/09/28/TimescaleDB/">
            <time datetime="2017-09-28T00:42:41.000Z" itemprop="datePublished">2017-09-28</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/database/">database</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="time-series数据的现有方案问题"><a href="#time-series数据的现有方案问题" class="headerlink" title="time series数据的现有方案问题"></a>time series数据的现有方案问题</h2><ul>
<li>传统RDBMS<ul>
<li>无法支持high ingest rate，尤其index无法完全放入内存后</li>
<li>delete的成本高<br>时序数据是有retention的</li>
</ul>
</li>
<li>NoSQL和time series database<br>Cassandar, MongoDB<br>OpenTSDB, InfluxDB<ul>
<li>通常缺乏丰富的查询接口，复杂查询是高延时</li>
</ul>
</li>
<li>Hadoop/Spark<br>ingest rate可以高，但查询慢</li>
</ul>
<h2 id="TimescaleDB解决办法"><a href="#TimescaleDB解决办法" class="headerlink" title="TimescaleDB解决办法"></a>TimescaleDB解决办法</h2><h3 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h3><p>PostgreSQL上的一个插件，目前只支持单机部署，cluster功能还在开发<br>因此，PQ具备的功能它都有，此外还针对tsdb提供了一些方便的函数</p>
<ul>
<li>hypertable<br>相当于多个chunk(物理)上的逻辑统一</li>
<li>chunk<br>相当于shard，物理属性，通过time interval和[partition key]进行路由<br>chunk就是PQ的table</li>
</ul>
<h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><h4 id="high-inject-rate"><a href="#high-inject-rate" class="headerlink" title="high inject rate"></a>high inject rate</h4><p>传统mysql/postgresql，受限于index，如果无法放到内存，性能会大大降低</p>
<p>在100亿条数据的hypertable，单机单磁盘，仍然可以享受10万插入/秒(in batch).</p>
<p>TimescaleDB solves this through its heavy utilization of time-space partitioning, even when running on a single machine.<br>So all writes to recent time intervals are only to tables that remain in memory, and updating any secondary indexes is also fast as a result.</p>
<h4 id="retention"><a href="#retention" class="headerlink" title="retention"></a>retention</h4><p>删除数据时，不是delete by row，而是delete by chunk，把整个chunk(table)删除就快了</p>
<pre><code>SELECT drop_chunks(interval &apos;7 days&apos;, &apos;conditions&apos;);
</code></pre><h4 id="chunk-partition"><a href="#chunk-partition" class="headerlink" title="chunk partition"></a>chunk partition</h4><p>目前不支持adaptive time intervals，需要在创建hypertable时手工指定chunk_time_interval(默认1个月)</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://funkygao.github.io/2017/09/28/TimescaleDB/" data-id="cjcxbtvc0002j005b44cv41ja" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://funkygao.github.io/2017/09/28/TimescaleDB/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://funkygao.github.io/2017/09/28/TimescaleDB/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-block-chain" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/09/11/block-chain/">blockchain</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/09/11/block-chain/">
            <time datetime="2017-09-11T00:25:49.000Z" itemprop="datePublished">2017-09-11</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/algorithm/">algorithm</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>目前公开的bitcoin只能支持每秒7笔的吞吐量，一般对于大额交易来说，安全的交易确认时间为1小时(6个block生成时间)</p>
<p>中本聪设计比特币时，为区块设置了1MB的容量限制，使每一个区块只能容纳4096个交易；同时，工作量证明机制使得确认交易并将交易记录到区块链中需要约10分钟</p>
<p>bitcoin是一种通货紧缩货币，到2140年到达最大值：2100万个比特币</p>
<p>blockchain的所谓去中心化，实际上是建立一个少数服从多数的分布式权威网络，只要这个网络上节点足够多，就是可以信赖的<br>以前，用户trust银行；现在，用户trust majority nodes in blockchain network</p>
<p>Bitcoin accounts: address<br>public key: 1MKe24pNsLmFYk9mJd1dXHkKj9h5YhoEey<br>private key: 5KkKR3VAjjPbHPzi3pWEHVQWrVa3C4fwD4PjR9wWgSV2D3kdmeM</p>
<p>Currently, the top 10 mining pools consistently create about 90% of the blocks, and China-based pools create more than 60% of the blocks.<br>所以，虽然bitcoin设计上是去中心的，但目前的现状是实际上控制在少数人手里</p>
<p><img src="https://bitsonblocks.files.wordpress.com/2015/09/miner_dist_2.jpg?w=594&amp;h=476&amp;crop=1" alt="miners"></p>
<h3 id="bitcoin"><a href="#bitcoin" class="headerlink" title="bitcoin"></a>bitcoin</h3><ul>
<li>Blocks<br>481,823</li>
<li>Total BTC<br>16.523M</li>
<li>Difficulty<br>923233068449</li>
<li>Network total<br>7,983,858 trillion hash per second</li>
<li>Blocks/hour<br>7.25</li>
</ul>
<h2 id="Key-Design"><a href="#Key-Design" class="headerlink" title="Key Design"></a>Key Design</h2><p>BlockChain是以牺牲效率和性能为代价但换来了可靠的安全的最终一致性的分布式数据库</p>
<ul>
<li>与数据库不同，它不保存状态，只保存commit log，而通过commit log来计算出状态<br>bitcoin的blockchain里并不保存balance，只有[]transaction(inputs, outputs, sender, receiver)</li>
<li>no range query</li>
<li>blockchain可以想象成只有1个table的replicated database</li>
<li>each transaction must commit before next transaction can enter proposal phase<ul>
<li>throughput bottleneck</li>
</ul>
</li>
</ul>
<p>关键技术</p>
<ul>
<li>P2P<br>节点发现和通信</li>
<li>hash, 非对称加密<br>sender: sign(privatekey_of_sender, publickey_of_receiver)</li>
<li>merkle tree</li>
<li>wallet app</li>
</ul>
<h3 id="Block"><a href="#Block" class="headerlink" title="Block"></a>Block</h3><p><img src="https://bitsonblocks.files.wordpress.com/2015/09/bitcoin_blockchain_infographic1.jpg" alt="blockchain"></p>
<h4 id="Merkle-Tree"><a href="#Merkle-Tree" class="headerlink" title="Merkle Tree"></a>Merkle Tree</h4><p>每一个block有一个merkle树，叶子节点是transaction，每个中间节点有2个指针(2叉树)<br>如果修改某一个transaction叶子，就会传递到tree root</p>
<p>merkle tree，目前还没有在bitcoin中使用，但它的作用是：<br>确认一个交易是否被confirm，只要下载block header+merkle tree，而不用下载整个block</p>
<h3 id="Proof-of-Work"><a href="#Proof-of-Work" class="headerlink" title="Proof of Work"></a>Proof of Work</h3><p>sha256(‘pay me, joe, 25 bitcoins. 000001’) =&gt; 4699f0e443b73ddd6fdc14d4662395361fa21f54e647c64e643a49c54fef511c<br>sha256(‘pay me, joe, 25 bitcoins. 000013’) =&gt; 0ac09823cf2309c63d425c21b1c3d83f6dbc4b8acfb80b37b2db3d544192b7e9</p>
<p>猜到第13个nonce，就得到1个0开头的hash<br>bitcoin目前的难度是需要14个0开头，实际上每增加1个0，就把原来的计算量提高了16倍</p>
<p>bitcoin sha256(input + nonce)，其中input包括</p>
<ul>
<li>computer code</li>
<li>receiving address(public key)</li>
<li>transactions</li>
<li>timestamp</li>
<li>prev hash</li>
</ul>
<h3 id="Sybil-Attack"><a href="#Sybil-Attack" class="headerlink" title="Sybil Attack"></a>Sybil Attack</h3><p>女巫攻击，来源是70年代的一部叫做《Sybil》的美国系列片。片中的女主角人格混乱，扮演着16个角色。</p>
<h3 id="Transaction"><a href="#Transaction" class="headerlink" title="Transaction"></a>Transaction</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">1. client send payment to replica nodes, proposing new log entries</div><div class="line">2. proposal会在replica nodes间进行广播(unconfirmed transaction)，进行leader election: proposal phase</div><div class="line">   transaction临时保存在node(miner)的内存</div><div class="line">3. 通过PoW，leader胜出，本地append到blockchain，并广播到其他replicas</div><div class="line">   miner之间是竞争关系，都在正确尽快solve the puzzle to be leader</div><div class="line">   miner会把unconfirmed transactions进行合并(batch)，生成到一个block(一个block最多4096个transactions)</div><div class="line">4. 所有replicas append to local blockchain，transaction confirmed</div><div class="line"></div><div class="line">block chain实际上实现了global transaction time order</div></pre></td></tr></table></figure>
<h3 id="Block-Acceptance"><a href="#Block-Acceptance" class="headerlink" title="Block Acceptance"></a>Block Acceptance</h3><p>收到miner发来的新block后，node会very block, verify each transaction, verify not spent<br>都成功，就加入local blockchain</p>
<p>如果local blockchain没有与main blockchain同步，那么verify block会失败，它会通过P2P请求同步，把unsynced blocks追上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">node1: block 1, 2, 3, 4</div><div class="line">main blockchain: 1, 2, 3, 4, 5, 6, 7</div><div class="line">此时node2成功创建了block8，并广播给node1</div><div class="line">node1发现block 5-7还没有同步过来，先进行同步，然后再把block8 append to local blockchain</div></pre></td></tr></table></figure>
<h3 id="Confirm"><a href="#Confirm" class="headerlink" title="Confirm"></a>Confirm</h3><p>确认数 = 该交易所在的block在blockchain中后面的block数量 + 1<br>如果确认数 &gt;= 6，那么就可以认为无法逆转了</p>
<h3 id="Consensus"><a href="#Consensus" class="headerlink" title="Consensus"></a>Consensus</h3><p>通过PoW，每次生成block时进行一次leader选举，由leader生产new block，猜数成功的node自认为成为了leader，然后通过P2P广播(gossip)<br>由于猜数比较困难，多节点同时成为leader并且在接收到其他leader广播前猜成功的可能性非常小，但还是存在可能性，即多主，这就需要解决冲突</p>
<p>miner一旦recv a new block，就意识到在这个block的race上自己输了，它会立即把一些pending transactions和这个收到的block作为prev hash来构建下一个block</p>
<h3 id="Conflict-Resolve"><a href="#Conflict-Resolve" class="headerlink" title="Conflict Resolve"></a>Conflict Resolve</h3><p>采用longest chain rule，发现冲突时，block chain fork branch，在发现longest chain时，把short chain删除：但可能会造成confirmed transaction lost</p>
<p><img src="https://github.com/funkygao/blogassets/blob/master/img/longrule1.png?raw=true" alt="conflict"><br><img src="https://github.com/funkygao/blogassets/blob/master/img/longrule2.png?raw=true" alt="resolve"></p>
<h3 id="Double-Spent"><a href="#Double-Spent" class="headerlink" title="Double Spent"></a>Double Spent</h3><p><img src="https://github.com/funkygao/blogassets/blob/master/img/double_spend1.jpg?raw=true" alt="double-spent"></p>
<h3 id="Public-keys-as-identities"><a href="#Public-keys-as-identities" class="headerlink" title="Public keys as identities"></a>Public keys as identities</h3><p>Alice pays Bob，Alice会把这个交易通过private key进行签名，广播给miners</p>
<ul>
<li>Bob不需要参与</li>
<li>交易信息里只包含Alice和Bob的public keys(address)</li>
<li>You can create a new identity at any time by generating a new key pair<br>with no central authority or registry</li>
</ul>
<h3 id="验证身份verify"><a href="#验证身份verify" class="headerlink" title="验证身份verify"></a>验证身份verify</h3><p><img src="https://github.com/funkygao/blogassets/blob/master/img/digital_signature.png?raw=true" alt="signature"></p>
<p>比特币的所有权是通过数字密钥、比特币地址、数字签名来确立的<br>密钥实现了去中心化的信任，所有权认证</p>
<p>创建交易时，payer利用自己的private key给transaction签名，同时把自己的public key存放在消息里：(payer_public_key, signature)<br>miners通过这个信息，就可以verify这个transaction确实是payer发出的<br>同时，transaction里也包含了payee的public key信息，只有payee利用他的private key才能解开</p>
<p>key pair，非对称加密的特性：</p>
<ul>
<li>用私钥加密的内容，只能用公钥解密<br>如果能通过(payer_public_key, signature)能解密，就证明了payer的身份</li>
<li>用公钥加密的内容，只能用私钥解密<br>只有payee才能用他的私钥解密交易<br>每个交易必须有效的签名才能被存入ledger<br>当payee花销这笔钱时，他必须给这个交易签名，由于这笔钱已经在ledger里记录了payee的公钥，只有payee才能签名</li>
<li>公钥用于收钱，私钥用于花钱时生成数字签名</li>
<li>通过私钥能计算出公钥，但反过来不行<br>只要私钥不丢，公钥丢了也没关系</li>
</ul>
<p>如果我知道Alice的public key(X)，然后创建一笔交易：X支付给me 1BTC，系统是怎么知道有诈的?<br>首先我不知道X对应的私钥，只能拿我的私钥对交易加签名，miner通过X和signature就能验证：invalid signature</p>
<h3 id="Upgrade"><a href="#Upgrade" class="headerlink" title="Upgrade"></a>Upgrade</h3><p><a href="https://github.com/bitcoin/bips" target="_blank" rel="external">https://github.com/bitcoin/bips</a></p>
<p>BIP(bitcoin improvement proposal)在github上发布，miners自愿地下载、启动，但不是强制的</p>
<h2 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q &amp; A"></a>Q &amp; A</h2><h3 id="为什么blocks通过hash进行chain，而不是通过普通的编号？"><a href="#为什么blocks通过hash进行chain，而不是通过普通的编号？" class="headerlink" title="为什么blocks通过hash进行chain，而不是通过普通的编号？"></a>为什么blocks通过hash进行chain，而不是通过普通的编号？</h3><p>因为hash具有不可篡改性，hash本身包含了内容的指纹</p>
<h3 id="同时有很多client进行交易，full-node一直在瞎忙活？"><a href="#同时有很多client进行交易，full-node一直在瞎忙活？" class="headerlink" title="同时有很多client进行交易，full node一直在瞎忙活？"></a>同时有很多client进行交易，full node一直在瞎忙活？</h3><p>T1, T2, Tn被分发到n个full node，那么每个node都开始猜数，其中一个node(N1)猜中，开始广播，此时N2~Nn还在为自己的Tn进行猜数，发现new block，就停下手中的活，重新生成新的block，并重新猜数<br>如果N1在广播时，消息还没有传到Nx，而此时Nx的猜数工作是不会停的；如果此时Nx也猜数成功，那么在它还没有收到N1广播前，就会广播自己的new block，此时fork出现<br>对于某一个full node，它可能会并发接收多个交易请求，它会进行串行化</p>
<h3 id="如果识别一个account"><a href="#如果识别一个account" class="headerlink" title="如果识别一个account"></a>如果识别一个account</h3><p>通过wallet程序，每次交易都可以生成新的public/private key pair，由wallet管理并保存。如果wallet的数据丢了，那么bitcoin就无法证明是你的了</p>
<h3 id="如何动态维护PoW的难度？"><a href="#如何动态维护PoW的难度？" class="headerlink" title="如何动态维护PoW的难度？"></a>如何动态维护PoW的难度？</h3><p>每个节点计算最近2016个solution，因为频率应该是10分钟一个，因此2016个，应该是2016/(6*24)=14天<br>而每个block里都有timestamp<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">elapsed = timestamp(block(-2016)) - timestamp(block(-1)) </div><div class="line">// 例如，假如elapsed = 7 day，那么说明难度系统太低了</div><div class="line">// 即，移动平均数</div><div class="line">difficulty = difficulty * 2</div></pre></td></tr></table></figure></p>
<h3 id="如何保证bitcoin-address唯一？"><a href="#如何保证bitcoin-address唯一？" class="headerlink" title="如何保证bitcoin address唯一？"></a>如何保证bitcoin address唯一？</h3><p>Bitcoin address是由34个alphanumerical组成的字符串，但排除了O/T/l/0，它的空间是58^34，即<br>904798310844700775313327215140493940623303545877497699631104<br>但里面有几位用于checksum，它的实际空间是2^160，即<br>1461501637330902918203684832716283019655932542976</p>
<h3 id="一个恶意node可以做什么，不能做什么？"><a href="#一个恶意node可以做什么，不能做什么？" class="headerlink" title="一个恶意node可以做什么，不能做什么？"></a>一个恶意node可以做什么，不能做什么？</h3><p>它能</p>
<ul>
<li>Refuse to relay valid transactions to other nodes<br>但其他节点会replay</li>
<li>Attempt to create blocks that include or exclude specific transactions of his choosing</li>
<li>Attempt to create a ‘longer chain’ of blocks that make previously accepted blocks become ‘orphans’ and not part of the main chain</li>
</ul>
<p>它不能</p>
<ul>
<li>Steal bitcoins from your account</li>
<li>Make payments on your behalf or pretend to be you</li>
</ul>
<h3 id="为什么建议每次transaction都新生成key-pair？"><a href="#为什么建议每次transaction都新生成key-pair？" class="headerlink" title="为什么建议每次transaction都新生成key pair？"></a>为什么建议每次transaction都新生成key pair？</h3><p>公钥虽然没有安全问题，但有隐私，毕竟它属于某一个人，如果我的交易都用一个key pair，那么最终这些交易可以发现是一个人的行为</p>
<h3 id="如果写错了接受者payee公钥，这笔钱能回来吗？"><a href="#如果写错了接受者payee公钥，这笔钱能回来吗？" class="headerlink" title="如果写错了接受者payee公钥，这笔钱能回来吗？"></a>如果写错了接受者payee公钥，这笔钱能回来吗？</h3><p>首先，公钥(bitcoin address)是有校验位的，写错的时候，基本上就可以在提交时离线发现<br>如果恰巧校验一致，而地址是不存在的，那么交易会成功，但由于那个payee不存在，也就不存在对应的private key，也就无法spend it：黑洞，那笔钱永远消失了</p>
<p>如果本来我想给A钱，却输入时写成了B的address，那么：<br>Bitcoin transactions are not reversible. Sending to the wrong person cannot be undone.</p>
<h3 id="Block-timestamp如果做假怎么办？"><a href="#Block-timestamp如果做假怎么办？" class="headerlink" title="Block timestamp如果做假怎么办？"></a>Block timestamp如果做假怎么办？</h3><p>A timestamp is accepted as valid if it is greater than the median timestamp of previous 11 blocks, and less than the network-adjusted time + 2 hours.<br>“Network-adjusted time” is the median of the timestamps returned by all nodes connected to you.</p>
<p>Whenever a node connects to another node, it gets a UTC timestamp from it, and stores its offset from node-local UTC. The network-adjusted time is then the node-local UTC plus the median offset from all connected nodes. Network time is never adjusted more than 70 minutes from local system time, however.</p>
<h3 id="如果真有人控制了51-计算能力，会发生什么？"><a href="#如果真有人控制了51-计算能力，会发生什么？" class="headerlink" title="如果真有人控制了51%计算能力，会发生什么？"></a>如果真有人控制了51%计算能力，会发生什么？</h3><p>attacker只能把他刚花的钱payment取消掉，即double spent</p>
<h3 id="据说bitcoin最大吞吐量是7-TPS，怎么计算来的？"><a href="#据说bitcoin最大吞吐量是7-TPS，怎么计算来的？" class="headerlink" title="据说bitcoin最大吞吐量是7 TPS，怎么计算来的？"></a>据说bitcoin最大吞吐量是7 TPS，怎么计算来的？</h3><p>每个block最大1MB，4096个transaction，10分钟产生一个block</p>
<p>4096/(10*60) = 6.83 = 7</p>
<h3 id="miner做恶的惩罚"><a href="#miner做恶的惩罚" class="headerlink" title="miner做恶的惩罚"></a>miner做恶的惩罚</h3><p>miner竞争成功后，创建一个block，它会获得奖励；如果它发布一个非法的block，那么大部分miners会拒绝；并在下一个block时，该非法block被取消，同时它的奖励也被取消。除非，它能保证它一直是竞争成功</p>
<h3 id="seed-nodes"><a href="#seed-nodes" class="headerlink" title="seed nodes?"></a>seed nodes?</h3><p>hard coded<br><a href="https://github.com/bitcoin/bitcoin/blob/863e995b79ec388bf292d80f181912d01e20e2e5/src/net.cpp#L1198" target="_blank" rel="external">https://github.com/bitcoin/bitcoin/blob/863e995b79ec388bf292d80f181912d01e20e2e5/src/net.cpp#L1198</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">unsigned int pnSeed[] =</div><div class="line">&#123;</div><div class="line">    0x959bd347, 0xf8de42b2, 0x73bc0518, 0xea6edc50, 0x21b00a4d, 0xc725b43d, 0xd665464d, 0x1a2a770e,</div><div class="line">    0x27c93946, 0x65b2fa46, 0xb80ae255, 0x66b3b446, 0xb1877a3e, 0x6ee89e3e, 0xc3175b40, 0x2a01a83c,</div><div class="line">    0x95b1363a, 0xa079ad3d, 0xe6ca801f, 0x027f4f4a, 0x34f7f03a, 0xf790f04a, 0x16ca801f, 0x2f4d5e40,</div><div class="line">    0x3a4d5e40, 0xc43a322e, 0xc8159753, 0x14d4724c, 0x7919a118, 0xe0bdb34e, 0x68a16b2e, 0xff64b44d,</div><div class="line">    // 列出了500多个节点</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://bitcoincharts.com/" target="_blank" rel="external">https://bitcoincharts.com/</a><br><a href="https://blockchain.info/" target="_blank" rel="external">https://blockchain.info/</a><br><a href="https://en.bitcoin.it/wiki/Vocabulary" target="_blank" rel="external">https://en.bitcoin.it/wiki/Vocabulary</a><br><a href="http://www.cs.rice.edu/Conferences/IPTPS02/101.pdf" target="_blank" rel="external">http://www.cs.rice.edu/Conferences/IPTPS02/101.pdf</a><br><a href="https://www.cryptocompare.com/wallets/guides/how-to-create-a-bitcoin-address-from-a-public-key/" target="_blank" rel="external">https://www.cryptocompare.com/wallets/guides/how-to-create-a-bitcoin-address-from-a-public-key/</a></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://funkygao.github.io/2017/09/11/block-chain/" data-id="cjcxbtvce0035005bqx3u8l90" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://funkygao.github.io/2017/09/11/block-chain/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://funkygao.github.io/2017/09/11/block-chain/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-perceptual-hash" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/08/24/perceptual-hash/">perceptual hash</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/08/24/perceptual-hash/">
            <time datetime="2017-08-23T23:43:24.000Z" itemprop="datePublished">2017-08-24</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/algorithm/">algorithm</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>这种算法的优点是简单快速，不受图片大小缩放的影响，缺点是图片的内容不能变更。如果在图片上加几个文字，它就认不出来了。所以，它的最佳用途是根据缩略图，找出原图。</p>
<p>实际应用中，往往采用更强大的pHash算法和SIFT算法，它们能够识别图片的变形。只要变形程度不超过25%，它们就能匹配原图。这些算法虽然更复杂，但是原理与上面的简便算法是一样的，就是先将图片转化成Hash字符串，然后再进行比较。</p>
<p>比较图片的相似度<br>图片尺寸可以不同，不同的长宽比例，小范围的颜色不同(亮度、对比度等)<br>对旋转都不具有鲁棒性：但可以sample argument</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">img = resize(img, (8, 8))</div><div class="line">img.grayscalize(level=64)</div><div class="line">avg = img.average() // e,g. 78</div><div class="line">for i, b = range img &#123; // (8, 8) =&gt; img[0...63]</div><div class="line">    if b &gt;= avg &#123;</div><div class="line">        img[i] = 1</div><div class="line">    &#125; else &#123;</div><div class="line">        img[i] = 0</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">// img现在就是一个64位的二进制整数, 这就是这张图片的指纹</div><div class="line"></div><div class="line">HanmingDistance(img1, img2) // 汉明距离，如果小于5就说明两副图相似</div></pre></td></tr></table></figure>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://funkygao.github.io/2017/08/24/perceptual-hash/" data-id="cjcxbtvdu0052005bzcxd0w31" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://funkygao.github.io/2017/08/24/perceptual-hash/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://funkygao.github.io/2017/08/24/perceptual-hash/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-GFS" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/07/25/GFS/">GFS evolution and BigTable</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/07/25/GFS/">
            <time datetime="2017-07-25T06:39:34.000Z" itemprop="datePublished">2017-07-25</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/storage/">storage</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="GFS"><a href="#GFS" class="headerlink" title="GFS"></a>GFS</h2><p>GFS，2001年开发出来，3个人，1年，论文发表于2003<br>BigTable，2004年开发出来，论文发表于2006</p>
<h3 id="master"><a href="#master" class="headerlink" title="master"></a>master</h3><ul>
<li>replicated operation(redo) log with checkpoint to shadow masters<ul>
<li>当时没有自动failover，全是人工操作DNS alias</li>
<li>read请求可以使用shadow masters</li>
<li>生成checkpoint时，master切换到新的redo log file，创建新线程生成checkpoint<br>在此过程中发生的变化，记录到新redo log file</li>
<li>operation log保证了mutation的全局有序</li>
<li>save checkpoint<br>很可能是通过mmap+msync</li>
</ul>
</li>
<li>bottleneck?<ul>
<li>当时部署了多个cluster，根据业务属性<br>最大的超过1000节点，300TB</li>
<li>过高的OPS<br>由于redo log需要复制，master的tps也就在1万左右<ul>
<li>client cache<br>何时invalidate and recall master?<ul>
<li>primary unreachable</li>
<li>primary reponse: no lease</li>
</ul>
</li>
<li>client batch request</li>
<li>lease</li>
</ul>
</li>
<li>内存容量<ul>
<li>prefix compression to reduce memory footprint</li>
<li>每个chunk(64MB)，metadata占内存64B<br>如果保存1百万个文件(64TB)，需要64MB内存<br>如果保存10亿个文件(64PB)，需要64GB内存<br>实际上是到了5千万个文件，10PB的时候，master已经到达瓶颈了</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="metadata"><a href="#metadata" class="headerlink" title="metadata"></a>metadata</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">type metadata &#123;</div><div class="line">    filename string // prefix compression</div><div class="line">    owner uid</div><div class="line">    perm acl</div><div class="line">    chunks []chunk &#123;</div><div class="line">        chunk_id int64</div><div class="line">        version int</div><div class="line">        refCount int // for snapshot COW</div><div class="line">        chunkservers []string // ip addr</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h3><p>rename to hidden file，保留3天，之后真正删除</p>
<h3 id="write-mutation"><a href="#write-mutation" class="headerlink" title="write/mutation"></a>write/mutation</h3><ul>
<li>operation log replicated between master and shadows</li>
<li>client write data flow to pipelined chain chunkservers</li>
<li>primary write control flow to secondary chunkservers</li>
</ul>
<h3 id="read-filename-offset-size"><a href="#read-filename-offset-size" class="headerlink" title="read(filename, offset, size)"></a>read(filename, offset, size)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">client根据(offset, size)计算出需要哪些chunks，假设chunk1, chunk2</div><div class="line">client把(filename, chunk index [1, 2])类似batch一样发送master</div><div class="line">master返回&#123;chunk1: &#123;chunkId1, [ip1, ip2, ip3]&#125;, chunk2: &#123;chunkId2, [ip4, ip5, ip6]&#125;&#125;</div><div class="line">client.putInCache(metadata)</div><div class="line">client顺序地获取chunk1, chunk2</div><div class="line">对于chunk1，根据ip1-3与client ip的距离，找最近的，取chunk；如果失败，找下一个最近的chunkserver</div><div class="line">client.sendToIp1(chunkId1, offset1, size1)</div><div class="line"></div><div class="line">// stale read是存在的，read的时候chunkserver可能发现data corruption</div></pre></td></tr></table></figure>
<h3 id="磁盘错误的解决"><a href="#磁盘错误的解决" class="headerlink" title="磁盘错误的解决"></a>磁盘错误的解决</h3><p>file -&gt; chunk -&gt; block</p>
<p>在每个chunkserver上执行，通过checksum检测</p>
<p>每个chunk由多个64KB的block组成，每个block有一个32位的checksum</p>
<p>read repair，如果chunkserver发现了一个非法block，会返回client err，同时向master汇报</p>
<ul>
<li>client会从其他replica read</li>
<li>master会从其他有效的replica把这整个chunk clone到另外一个chunkserver，然后告诉有问题的chunkserver删除那个chunk</li>
</ul>
<h3 id="Questions"><a href="#Questions" class="headerlink" title="Questions"></a>Questions</h3><h4 id="chunk为什么64MB那么大"><a href="#chunk为什么64MB那么大" class="headerlink" title="chunk为什么64MB那么大?"></a>chunk为什么64MB那么大?</h4><ul>
<li>减少master内存的占用</li>
<li>减少client与master的交互<br>同一个chunk的R/W，client只需要与master交互一次</li>
<li>可以很容易看到机器里哪些机器磁盘快满了，而做迁移</li>
<li>可以减少带宽的hotspot<br>如果没有chunk，那么1TB的文件就只能从一个replica读<br>有了chunk，可以从多个replica读</li>
<li>sharding the load</li>
<li>加快recovery时间<br>每个chunk，可以很快地被clone到一台新机器</li>
<li>如果一个file只有1MB，那么实际存储空间是1MB，而不是64MB<br>但它会增加master file count问题</li>
<li>可以独立replicate<ul>
<li>文件的一部分损坏，可以迅速从好的replica恢复</li>
<li>支持更细粒度的placement</li>
</ul>
</li>
<li>支持超大文件</li>
</ul>
<h4 id="chunk-hotspot问题"><a href="#chunk-hotspot问题" class="headerlink" title="chunk hotspot问题"></a>chunk hotspot问题</h4><p>MapReduce时，需要把代码发布到GFS，很可能小于64MB，即只有1个chunk，当很多mapper时，这个chunkserver就成为hotspot<br>解决办法是：增加replication factor</p>
<p>但最终的解决方案是：client间P2P，互相读</p>
<h4 id="master为什么不用Paxos"><a href="#master为什么不用Paxos" class="headerlink" title="master为什么不用Paxos?"></a>master为什么不用Paxos?</h4><p>master通过redo log sync replication来提高可靠性，但没有election过程，都是完全手工进行failover</p>
<p>我猜，chubby当时还没有启动，chubby论文发表于2006</p>
<h4 id="master为什么不持久化chunk-location"><a href="#master为什么不持久化chunk-location" class="headerlink" title="master为什么不持久化chunk location?"></a>master为什么不持久化chunk location?</h4><p>其他的metadata是有redo log replication并持久化的，他们的变化，都是主动产生的，例如创建一个文件，增加一个chunk<br>而由于chunkserver随时可能crash，不受控制，因此通过heartbeat来计算并存放内存，通过heartbeat，master又可以修正chunkserver的一些错误，例如orphan chunk</p>
<h4 id="Data-flow为什么pipelined-chain，而不并发"><a href="#Data-flow为什么pipelined-chain，而不并发" class="headerlink" title="Data flow为什么pipelined chain，而不并发?"></a>Data flow为什么pipelined chain，而不并发?</h4><p>为了避免产生网络瓶颈，同时为了更充分利用high latency links<br>通过ip地址，感知chunkserver直接的距离</p>
<p>Total Latency = (B/T) + (R*L)</p>
<p>2PC，避免了client(coordinator) crash问题，因为primary成为了coordinator，而它是有failover的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">client负责把一个write请求分成多个chunk的请求</div><div class="line"></div><div class="line">Phase1: data flow  client -&gt; chained chunkservers</div><div class="line">相当于prepare，但数据不落盘</div><div class="line">client由近及远地chain把数据写入相应chunkserver的LRU buffer</div><div class="line">这个顺序跟primary在哪无关</div><div class="line"></div><div class="line">Phase2: control flow  client -&gt; primary -&gt; secondary chunkservers</div><div class="line">相当于commit，数据visible</div><div class="line">确定mutation order</div><div class="line"></div><div class="line">Phase1出错，则等master来修复，把crashed chunkserver摘除</div><div class="line">Phase2出错，primary-&gt;secondary，这个阶段，那么primary返回client err，client会重试，此时可能出现不一致的状态，但最终master会修复</div></pre></td></tr></table></figure></p>
<h4 id="为什么搞个primary角色，而不让master做"><a href="#为什么搞个primary角色，而不让master做" class="headerlink" title="为什么搞个primary角色，而不让master做?"></a>为什么搞个primary角色，而不让master做?</h4><p>为了减轻master负担，所以搞了个二级调度:<br>跨chunk，master负责；chunk内部，primary负责</p>
<h4 id="master如何revoke-primary-lease"><a href="#master如何revoke-primary-lease" class="headerlink" title="master如何revoke primary lease?"></a>master如何revoke primary lease?</h4><p>在lease expire后，master可能什么都不做<br>在lease expire前，master会sendto(primary)让它取消；如果sendto失败，那么只能等expire</p>
<h4 id="为什么data-flow和control-flow分开"><a href="#为什么data-flow和control-flow分开" class="headerlink" title="为什么data flow和control flow分开?"></a>为什么data flow和control flow分开?</h4><p>如果不分开，那么所有的数据都是client-&gt;primary-&gt;secondary<br>分开后，比较轻量级的control flow必须走primary扩散；重量级的data flow可以根据物理拓扑进行优化</p>
<h2 id="GFS-vs-Ceph"><a href="#GFS-vs-Ceph" class="headerlink" title="GFS vs Ceph"></a>GFS vs Ceph</h2><ul>
<li>论文2003 vs 2006</li>
<li>chunk(64MB) vs Object(4MB)<br>object size可配</li>
<li>master vs mon(Paxos)</li>
<li>chunkserver vs osd</li>
<li>replication<ul>
<li>GFS<br>2PC, decouple data/control flow</li>
<li>Ceph<br>client &lt;-&gt; osd</li>
</ul>
</li>
<li>Ceph通过PG+crunch提高了扩展性<br>GFS通过allocation table的方式</li>
<li>GFS上直接跑MapReduce<br>计算向存储locality</li>
<li>Ceph更通用，latency更好<br>GFS通过lease提高扩展性，但遇到错误时只能等expire</li>
<li>节点的变化<ul>
<li>GFS<br>chunkserver向master汇报，自动加入，完全不需要人工参与</li>
<li>Ceph<br>需要通过ceph osd命令，手工执行</li>
</ul>
</li>
<li>namespace<br>GFS是directory，Ceph是flat object id</li>
</ul>
<h2 id="2009-GFS回顾"><a href="#2009-GFS回顾" class="headerlink" title="2009 GFS回顾"></a>2009 GFS回顾</h2><p>GFS在使用了10年的过程中，发现了一些问题，对这些问题，有的是通过上层的应用来解决的，有的是修改GFS解决的</p>
<h3 id="master-ops压力"><a href="#master-ops压力" class="headerlink" title="master ops压力"></a>master ops压力</h3><p>最开始的设计，考虑的是支撑几百TB，几百万个文件。但很快，到了几十PB，这对master有了压力</p>
<ul>
<li>master在recover的时候，也变慢</li>
<li>master要维护的数据更多</li>
<li>client与master的交互变慢<br>每次open，client都要请求master<br>MapReduce下，可能突然多出很多task，每个都需要open，master处理能力也就是每秒几千个请求<br>解决办法是在应用层垂直切分，弄多个cluster，应用通过静态的NameSpace找自己的master，同时提升单个master能力到数万ops</li>
</ul>
<p>随着GFS的内部推广，越来越多的千奇百怪的上层应用连接进来</p>
<ul>
<li>最开始是爬虫和索引系统</li>
<li>然后QA和research组用GFS来保存large data sets</li>
<li>再然后，就有50多个用户了</li>
<li>在此过程中GFS不断地调整以满足新use case</li>
</ul>
<h3 id="file-count问题"><a href="#file-count问题" class="headerlink" title="file-count问题"></a>file-count问题</h3><p>很早就发现了，例如：</p>
<ul>
<li>前端机上要把log发到GFS保存以便MapReduce分析，前端机很多，每个log每天会logrotate，log的种类也越来越多</li>
<li>gmail需要保存很多小文件<br>解决办法是把多个文件合并，绕开file-count问题，同时增加quota功能，限制file-count和storage space<br>长远的办法：在开发distributed multi-master系统，一个cluster可以有上百个master，每个master可以存1亿个文件，但<br>如果都是小文件，会有新的问题出现：more seek<br>再后来，建立在GFS之上的BigTable推出了，帮助GFS直接面对应用对小文件、多文件的需求，BigTable层给解决了，BigTable在使用GFS时，仍然是大文件、少文件</li>
</ul>
<h3 id="latency问题"><a href="#latency问题" class="headerlink" title="latency问题"></a>latency问题</h3><p>GFS设计是只考虑吞吐率，而少考虑latency</p>
<h4 id="error-recovery慢"><a href="#error-recovery慢" class="headerlink" title="error recovery慢"></a>error recovery慢</h4><p>如果write一个文件，需要写到3个chunkserver，如果其中一个卡住了或crash，master会发觉(heartbeat)，它会开新的一个chunkserver replica从其他chunkserver pull<br>master会把这个lock，以便新的client不能write(等恢复后再unlock)<br>而这个pullchunk操作，为了防止bandwidth burst，是有throttle的，限制在5-10MB/s，即一个64MB chunk，需要10s左右<br>等恢复到3个ok的时候再返回给client，client再继续write<br>在此过程中，client一直是block的</p>
<h4 id="master-failover慢"><a href="#master-failover慢" class="headerlink" title="master failover慢"></a>master failover慢</h4><p>刚开始master failover完全靠人工，可能需要1h；后来增加了自动master failover，需要几分钟；再改进，可以在几秒钟内完成master自动切换</p>
<h4 id="为吞吐量而设计的batch增加latency"><a href="#为吞吐量而设计的batch增加latency" class="headerlink" title="为吞吐量而设计的batch增加latency"></a>为吞吐量而设计的batch增加latency</h4><h4 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h4><p>BigTable是无法忍受那么高的延时的，它的transaction log是最大的瓶颈，存储在GFS：<br>2个log(secondary log)，一个慢，就切换到另外一个，这2个log任意时刻只有1个active，并且log entry里有sequence号，以便replay时防重<br>google使用这个request redundancy or timeout方法很广泛，为了解决search long tail latency，一样思路</p>
<p>Gmail是多机房部署的，一个卡了，切到另外机房</p>
<h3 id="consistency"><a href="#consistency" class="headerlink" title="consistency"></a>consistency</h3><p>client一直push the write till it succeeds<br>但如果中途client crash了，会造成中间状态：不同client读同一个文件，可能发现文件长度不同<br>解决办法：使用append，offset统一由primary管理</p>
<p>但append由于没有reply保护机制，也有问题：<br>client write，primary分配一个offset，并call secondary，有的secondary收到有的没收到，此时primary crash<br>master会选另外一个作为primary，它可能会分配一个新的offset，造成该数据重复<br>如果为此再设计一套consensus，得不偿失<br>解决办法：single writer，让上层应用保证不并发写</p>
<h2 id="Colossus"><a href="#Colossus" class="headerlink" title="Colossus"></a>Colossus</h2><p>Colossus is specifically designed for BigTable, 没有GFS那么通用<br>In other words, it was built specifically for use with the new Caffeine search-indexing system, and though it may be used in some form with other Google services, it is not the sort of thing that is designed to span the entire Google infrastructure.</p>
<ul>
<li>automatically sharded metadata layer</li>
<li>EC</li>
<li>client driven replication</li>
<li>metadata space has enabled availability analysis</li>
</ul>
<h2 id="BigTable"><a href="#BigTable" class="headerlink" title="BigTable"></a>BigTable</h2><p><img src="https://github.com/funkygao/blogassets/blob/master/img/bigtable.jpg?raw=true" alt="(row, column, time) -&gt; value"></p>
<p>在有了GFS和Chubby后，Google就可以在上面搭建BigTable了，一个GFS的索引服务<br>但BigTable论文对很多细节都没有提到：SSTable的实现、tabletserver的HA，B+数的metadata table算法</p>
<p>为了管理巨大的table，按照row key做sharding，每个shard称为tablet(100-200MB，再大就split)，每台机器存储100-1000个tablet<br>row key是一级索引，column是二级索引，版本号(timestamp)是三级索引</p>
<p><img src="https://github.com/funkygao/blogassets/blob/master/img/tablet-write.png?raw=true" alt="redo log和SSTable都存放在GFS的Chubby管理元信息的分布式LSM Tree"></p>
<p>tabletserver没有任何的持久化数据，只是操作memtable，真正的数据存放在哪里只有GFS知道，那为什么需要master在chubby上分配tablet给tabletserver?<br>因为memtable是有状态的: level0</p>
<p>tabletserver的HA?<br>通过chubby ephemeral node，死了master会让别的server接管，通过GFS上的redo log恢复memtable<br>为了保证强一致性系统，同一时刻同一份数据只能一台tabletserver服务，tabletserver对每个tablet是没有备份的<br>当它crash，由于只需要排序很少的操作日志并且加载服务的tablet的索引，宕机恢复可以做到一分钟以内；在此期间，一部分rowkey不可用</p>
<p>split and migration?<br>在没有crash情况下，只需要修改metadata和从sstable加载索引数据，效率很高</p>
<h3 id="与GFS的对应"><a href="#与GFS的对应" class="headerlink" title="与GFS的对应"></a>与GFS的对应</h3><ul>
<li>commit log<br>每台机器一个commit log文件，与GFS File一一对应</li>
<li>sstable<br>HBase中Column Family的名称会被作为文件系统中的目录名称，每个CF存储成一个HDFS的HFile<br>据google工作过的人说：Column Families are stored in their own SSTable，应该是这样<br>sstable对应一个GFS File<br>sstable block=64KB，它与GFS的block相同<br>sstable block为了压缩和索引(binary search)，GFS block为了checksum</li>
</ul>
<h3 id="Highlights"><a href="#Highlights" class="headerlink" title="Highlights"></a>Highlights</h3><h4 id="redo-log合并"><a href="#redo-log合并" class="headerlink" title="redo log合并"></a>redo log合并</h4><p>一台机器一个redo log，而不是一个tablet一个redo log(每个机器有100-1000个tablet)，否则GFS受不了<br>group commit</p>
<p>带来的问题：恢复时麻烦了<br>如果一天机器crash了，它上面的tablets会被master分配到很多其他的tabletserver上<br>例如，分配到了100台新tabletserver，他们都会read redo log and filter，这样redo log被读了100次<br>解决办法：利用类似MapReduce机制，在recovery之前先给redo log排序 <table, rowkey,="" log="" sequence="" number=""></table,></p>
<h4 id="加速tablet迁移"><a href="#加速tablet迁移" class="headerlink" title="加速tablet迁移"></a>加速tablet迁移</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sourceTablet.miniorCompaction() // 把memtable里内容dump到GFS的SSTable</div><div class="line">sourceTablet.stopServe()</div><div class="line">sourceTablet.miniorCompaction() // 把in-flight commit log对应的操作也持久化到GFS</div><div class="line">                                // 这样targetTablet就不需要从commit log recover了</div><div class="line">master.doSwitch()</div></pre></td></tr></table></figure>
<h4 id="SSTable由多个64KB的block组成"><a href="#SSTable由多个64KB的block组成" class="headerlink" title="SSTable由多个64KB的block组成"></a>SSTable由多个64KB的block组成</h4><p>压缩以block为单位，虽然相比在整个SSTable上压缩比小(浪费空间)，但对于随机读，可以只uncompress block而非整个SSTable</p>
<h3 id="经验和教训"><a href="#经验和教训" class="headerlink" title="经验和教训"></a>经验和教训</h3><p>遇到了新的问题</p>
<ul>
<li>发现了Chubby的bug</li>
<li>network corruption<br>通过给RPC增加checksum解决</li>
<li>delay adding features until clear how it will be used<br>刚开始想给API增加一个通用的事务机制，后来发现大部分人只需要单行事务</li>
<li>不仅监控server，也监控client<br>扩展了RPC，采样detailed trace of important actions</li>
<li>设计和实现都要简单、明了<br>BigTable代码10万行C++<br>tabletserver的membership协议的设计，最初：master给tabletserver发lease<br>结果：在网络出问题时大大降低了可用性(master无法reach tabletserver就只能等expire)<br>改进：实现了更复杂的协议，也利用了Chubby里非常少见的特性<br>结果：大量时间在调试edge case，很多时间在调试Chubby的代码<br>最终：回到简单的设计，只依赖Chubby，而且只使用它通用的特性</li>
</ul>
<h3 id="Questions-1"><a href="#Questions-1" class="headerlink" title="Questions"></a>Questions</h3><p>按照rowkey来shard，那么可能造成hotspot问题，client端比较难控制</p>
<h2 id="2009-BigTable回顾"><a href="#2009-BigTable回顾" class="headerlink" title="2009 BigTable回顾"></a>2009 BigTable回顾</h2><p>部署了500+个BigTable集群，最大的机器：70+ PB data; sustained: 10M ops/sec; 30+ GB/s I/O</p>
<ul>
<li>Lots of work on scaling</li>
<li>Improved performance isolation</li>
<li>Improved protection against corruption</li>
<li>Configure on per-table</li>
<li>异地机房复制: 增加了最终一致性模型</li>
<li>Coprocessor<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2></li>
</ul>
<p><a href="http://queue.acm.org/detail.cfm?id=1594206" target="_blank" rel="external">http://queue.acm.org/detail.cfm?id=1594206</a><br><a href="http://google-file-system.wikispaces.asu.edu/" target="_blank" rel="external">http://google-file-system.wikispaces.asu.edu/</a><br><a href="http://static.usenix.org/publications/login/2010-08/openpdfs/maltzahn.pdf" target="_blank" rel="external">http://static.usenix.org/publications/login/2010-08/openpdfs/maltzahn.pdf</a><br><a href="https://stephenholiday.com/notes/bigtable/" target="_blank" rel="external">https://stephenholiday.com/notes/bigtable/</a></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://funkygao.github.io/2017/07/25/GFS/" data-id="cjcxbtvaw000u005bhybmquzs" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://funkygao.github.io/2017/07/25/GFS/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://funkygao.github.io/2017/07/25/GFS/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-replication" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/07/19/replication/">replication models</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/07/19/replication/">
            <time datetime="2017-07-19T11:12:26.000Z" itemprop="datePublished">2017-07-19</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/storage/">storage</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="Models"><a href="#Models" class="headerlink" title="Models"></a>Models</h2><ul>
<li>primary-replica(failover, replica readable)/multi-master/chain</li>
<li>replica/ec</li>
<li>push/pull</li>
<li>sync/async</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Dynamo      PUSH coordinator -&gt; preference list next nodes in hash ring</div><div class="line">Raft/ZK     PUSH master commit log -&gt; majority ack</div><div class="line">GFS/Hadoop  chain replication</div><div class="line">ES          PUSH primary-replica model, master concurrently dispatch index req to all replicas</div><div class="line">MySQL       PUSH master async PUSH to slaves binlog</div><div class="line">Kafka       PULL(Fetch) ISR</div><div class="line">redis</div><div class="line">Ceph        PUSH primary-replica sync model with degrade mode 同步写入</div><div class="line">Swift</div><div class="line">Aurora      PUSH primary instance R(3)+W(4)&gt;N(6)</div></pre></td></tr></table></figure>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://funkygao.github.io/2017/07/19/replication/" data-id="cjcxbtvdw0058005baoxj7u8a" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://funkygao.github.io/2017/07/19/replication/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://funkygao.github.io/2017/07/19/replication/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-Google-container-evolution" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/07/19/Google-container-evolution/">Google container evolution</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/07/19/Google-container-evolution/">
            <time datetime="2017-07-19T01:45:30.000Z" itemprop="datePublished">2017-07-19</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/cloud/">cloud</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>Babbysitter &amp; GlobalWorkQueue -&gt; cgroup -&gt; Borg -&gt; Omega -&gt; Kubernetes</p>
<h2 id="Container"><a href="#Container" class="headerlink" title="Container"></a>Container</h2><p>容器提供的隔离还不完善，OS无法管理的，容器无法隔离(例如CPU Cache，内存带宽)，为了防止(cloud)恶意用户，需要在容器外加一层VM保护</p>
<p>container = isolation + image</p>
<p>数据中心：机器为中心 -&gt; 应用为中心<br>在Application与OS之间增加一层抽象：container<br>container的依赖大部分都存放在image了，除了OS的系统调用<br>实际上，应用仍然会受OS影响，像/proc, ioctl</p>
<h3 id="好处"><a href="#好处" class="headerlink" title="好处"></a>好处</h3><ul>
<li>更高的资源利用率</li>
<li>监控的是应用，而不是混在一起的机器</li>
<li>开发者、管理员不需关心OS</li>
<li>load balancer不再balance traffic across machines: across application instances</li>
<li>logs are keyed by application, not machine</li>
<li>可以更容易识别是应用的失败还是机器的失败</li>
</ul>
<h2 id="教训"><a href="#教训" class="headerlink" title="教训"></a>教训</h2><ul>
<li>不要给container端口号<br>Borg做法是物理机上的所有容器共用主机的ip，每个容器分单独的端口号<br>Kubernetes为每个pod分配不同ip，network身份=application身份</li>
<li>不要给container编号<br>用label</li>
<li>不用暴露raw state<br>减少client端的复杂度<br>K8s里，都通过API Service访问状态信息</li>
</ul>
<h2 id="还没有很好解决的问题"><a href="#还没有很好解决的问题" class="headerlink" title="还没有很好解决的问题"></a>还没有很好解决的问题</h2><ul>
<li>Configuration</li>
<li>Dependency management<br>手工配，最终一定不一致<br>自动，无法获取足够的语义信息</li>
</ul>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://funkygao.github.io/2017/07/19/Google-container-evolution/" data-id="cjcxbtvax000w005bw8b77faa" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://funkygao.github.io/2017/07/19/Google-container-evolution/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://funkygao.github.io/2017/07/19/Google-container-evolution/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-Ceph" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/07/18/Ceph/">Ceph Internals</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/07/18/Ceph/">
            <time datetime="2017-07-18T07:27:20.000Z" itemprop="datePublished">2017-07-18</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/storage/">storage</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="RADOS"><a href="#RADOS" class="headerlink" title="RADOS"></a>RADOS</h2><h3 id="Key-ideas"><a href="#Key-ideas" class="headerlink" title="Key ideas"></a>Key ideas</h3><p><img src="https://github.com/funkygao/blogassets/blob/master/img/ceph.png?raw=true" alt="components"></p>
<ul>
<li>把传统文件系统架构分隔成client component and storage component<br>client负责更上层的抽象(file, block, object)，storage负责底层object, disk</li>
<li>seperation of data and metadata<br>各管各的</li>
</ul>
<h3 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h3><p>Object是最终落地存储文件的基本单位，可以类比fs block，默认4MB<br>如果一个文件 &gt; object size，文件会被stripped，这个操作是client端完成的</p>
<p>It does not use a directory hierarchy or a tree structure for storage<br>It is stored in a flat-address space containing billions of objects without any complexity</p>
<p>Object组成</p>
<ul>
<li>key</li>
<li>value<br>在fs里用一个文件存储</li>
<li>metadata<br>可以存放在扩展的fs attr里<br>因此对底层文件系统是有要求的，ext4fs对extended attr数量限制的太少，可以用xfs</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">  +---logical------+       +--physical layer -+</div><div class="line">  |                |       |                  |</div><div class="line">cluster -&gt; pool -&gt; pg ---&gt; osd -&gt; object -&gt; fs files</div><div class="line">                   |       |                 </div><div class="line">                   +-crush-+</div></pre></td></tr></table></figure>
<h3 id="Lookup"><a href="#Lookup" class="headerlink" title="Lookup"></a>Lookup</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">file = ino</div><div class="line">obj = (ino, ono)</div><div class="line">obj_hash = hash(ino, ono)</div><div class="line">pg = obj_hash &amp; (num_pg-1) // num_pg是2整数幂，例如codis里1024</div><div class="line">                           // 官方推荐num_pg是osd总数的数百倍</div><div class="line">                           // num_pg如果变化，会引起大量的数据迁移</div><div class="line">osds_for_pg = crush(pg)    // list of osds，此处是唯一需要全局cluster map的地方</div><div class="line">                           // 其他的，都是算出来的</div><div class="line">                           // osds_for_pg is ordered，len(osds_for_pg)=replicate factor</div><div class="line">primary = osds_for_pg[0]</div><div class="line">replicas = osds_for_pg[1:]</div></pre></td></tr></table></figure>
<p><img src="https://github.com/funkygao/blogassets/blob/master/img/ceph-lookup.png?raw=true" alt="lookup"></p>
<h3 id="crush"><a href="#crush" class="headerlink" title="crush"></a>crush</h3><p>一个hash算法，目标</p>
<ul>
<li>数据均匀的分布到集群中</li>
<li>需要考虑各个OSD权重的不同（根据读写性能的差异，磁盘的容量的大小差异等设置不同的权重）</li>
<li>当有OSD损坏需要数据迁移时，数据的迁移量尽可能的少</li>
</ul>
<p>有点像一致性哈希：failure, addition, removal of nodes result in near-minimal object migration</p>
<p><img src="https://github.com/funkygao/blogassets/blob/master/img/ceph-crush.png?raw=true" alt="crush"></p>
<h3 id="PG"><a href="#PG" class="headerlink" title="PG"></a>PG</h3><p>PG(placement group)与Couchbase里的vbucket一样，codis里也类似，都是presharding技术</p>
<p>在object_id与osd中间增加一层pg，减少由于osd数量变化造成大量的数据迁移<br>PG使得文件的定位问题，变成了通过crush定位PG的问题，数量大大减少<br>例如，1万个osd，100亿个文件，30万个pg: 100亿 vs 30万</p>
<p>线上尽量不要更改PG的数量，PG的数量的变更将导致整个集群动起来（各个OSD之间copy数据），大量数据均衡期间读写性能下降严重</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Total PGs = (Total_number_of_OSD * 100) / max_replication_count</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ceph osd map pool1 object1</div><div class="line">osdmap e566 pool &apos;pool1&apos; (10) object &apos;object1&apos; -&gt; pg 10.bac4decb (10.3c) -&gt; up [0,6,3] acting [0,6,3]</div><div class="line">$</div><div class="line">// osdmap e566: osd map epoch 566</div><div class="line">// pool &apos;pool1&apos; (10): pool name and pool id，pool id从0开始，每新建+1</div><div class="line">// pg 10.bac4decb (10.3c): placement group number 10.3c(pg id是16进制，256个pg，那么他们的id: 0, 1, f, fe, ff)</div><div class="line">                           pg id实际上是pool_id.pg_id(pool id=10, pg id=3c)</div><div class="line">// up [0,6,3]: osd up set contains osd.0, osd.6, osd.3</div></pre></td></tr></table></figure>
<p>同一个PG内的osd通过heartbeat相互检查对方状态，大部分情况下不需要mon参与，减少了mon负担</p>
<h3 id="mon"><a href="#mon" class="headerlink" title="mon"></a>mon</h3><p>相当于Ceph的zookeeper</p>
<p>mon quorum负责整个Ceph cluster中所有OSD状态(cluster map)，然后以增量、异步、lazy方式扩散到each OSD和client<br>mon被动接收osd的上报请求，作为reponse把cluster map返回，不主动push cluster map to osd<br>如果client和它要访问的PG内部各个OSD看到的cluster map不一致，则这几方会首先同步cluster map，然后即可正常访问</p>
<p>MON跟踪cluster状态：OSD, PG, CRUSH maps<br>同一个PG的osd除了向mon发送心跳外，还互相发心跳以及坚持pg数据replica是否正常</p>
<h3 id="Replication"><a href="#Replication" class="headerlink" title="Replication"></a>Replication</h3><p>是primary-replica model, 强一致性，读和写只能向primary发起请求<br><img src="https://github.com/funkygao/blogassets/blob/master/img/ceph-rw.png?raw=true" alt="read write"><br><img src="https://github.com/funkygao/blogassets/blob/master/img/ceph-rw1.jpg?raw=true" alt="read write"><br>其中replicas在复制到buffer时就ack，如果某个replica复制时失败，进入degrade状态</p>
<h3 id="2PC-Write"><a href="#2PC-Write" class="headerlink" title="2PC Write"></a>2PC Write</h3><p><img src="https://github.com/funkygao/blogassets/blob/master/img/ceph-2pc.png?raw=true" alt="write 2PC"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">phase1: client从primay接收ack</div><div class="line">此时，数据已经replicate到每个replica的内存</div><div class="line"></div><div class="line">phase2: client从primary接收commit</div><div class="line">此时，数据已经replicate到每个replica的磁盘</div><div class="line">client才把本地的write buffer cache清除</div></pre></td></tr></table></figure>
<h3 id="scrub机制"><a href="#scrub机制" class="headerlink" title="scrub机制"></a>scrub机制</h3><p>read verify</p>
<h2 id="Questions"><a href="#Questions" class="headerlink" title="Questions"></a>Questions</h2><h3 id="consistency"><a href="#consistency" class="headerlink" title="consistency?"></a>consistency?</h3><p>strongly consistent</p>
<h3 id="Can-Ceph-replace-facebook-Haystack"><a href="#Can-Ceph-replace-facebook-Haystack" class="headerlink" title="Can Ceph replace facebook Haystack?"></a>Can Ceph replace facebook Haystack?</h3><p>Haystack解决的实际上是metadata访问造成的IO问题，解决的方法是metadata完全内存，无IO<br>每个图片的read，需要NetApp进行3次IO: dir inode, file inode, file data<br>haystack每个图片read，需要1次IO，metadata保证在内存<br>在一个4TB的SATA盘存储20M个文件，每个inode如果需要500B，那么如果inode都存放内存，需要10GB内存</p>
<ul>
<li>减少每个metadata的大小<br>去掉大部分不需要的数据，例如uid, gid, atime等<br>xfs里每个metadata占536字节，haystack每个图片需要10字节</li>
<li>减少metadata的总数量<br>多个图片(needle)合并进一个大文件(superblock)</li>
</ul>
<p>用户上传一张图片，facebook会将其生成4种尺寸的图片，每种存储3份，因此写入量是用户上传量的12倍。</p>
<p>Posix规范里的metadata很多对图片服务器不需要，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">struct inode &#123;</div><div class="line">    loff_t              i_size;  // 文件大小</div><div class="line">    struct list_head    i_list;  // backing dev IO list</div><div class="line">    struct list_head    i_devices;</div><div class="line">    blkcnt_t            i_blocks;</div><div class="line">    struct super_block  *i_sb;</div><div class="line">    struct timespec     i_atime;</div><div class="line">    struct timespec     i_mtime;</div><div class="line">    struct timespec     i_ctime;</div><div class="line">    umode_t             i_mode;</div><div class="line">    uid_t               i_uid;</div><div class="line">    gid_t               i_gid;</div><div class="line">    dev_t               i_rdev;</div><div class="line">    unsigned int        i_nlink;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Ceph解决了一个文件到分布式系统里的定位问题(crush(pg))，但osd并没有解决local store的问题: 如果一个osd上存储过多文件(例如10M)，性能会下降明显</p>
<h3 id="Why-EC-is-slow"><a href="#Why-EC-is-slow" class="headerlink" title="Why EC is slow?"></a>Why EC is slow?</h3><p>Google Colossus采用的是(6,3)EC，存储overhead=(6+3)/6=150%<br>把数据分成6个data block+3个parity block，恢复任意一个数据块需要6个I/O<br>生成parity block和恢复数据时，需要进行额外的encode/decode，造成性能损失</p>
<h3 id="Store-small-file-waste-space"><a href="#Store-small-file-waste-space" class="headerlink" title="Store small file, waste space?"></a>Store small file, waste space?</h3><p>object size是可以设置的</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="http://ceph.com/papers/weil-crush-sc06.pdf" target="_blank" rel="external">http://ceph.com/papers/weil-crush-sc06.pdf</a><br><a href="http://ceph.com/papers/weil-rados-pdsw07.pdf" target="_blank" rel="external">http://ceph.com/papers/weil-rados-pdsw07.pdf</a><br><a href="http://ceph.com/papers/weil-ceph-osdi06.pdf" target="_blank" rel="external">http://ceph.com/papers/weil-ceph-osdi06.pdf</a><br><a href="http://www.xsky.com/tec/ceph72hours/" target="_blank" rel="external">http://www.xsky.com/tec/ceph72hours/</a><br><a href="https://blogs.rdoproject.org/6427/ceph-and-swift-why-we-are-not-fighting" target="_blank" rel="external">https://blogs.rdoproject.org/6427/ceph-and-swift-why-we-are-not-fighting</a><br><a href="https://users.soe.ucsc.edu/~elm/Papers/sc04.pdf" target="_blank" rel="external">https://users.soe.ucsc.edu/~elm/Papers/sc04.pdf</a></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://funkygao.github.io/2017/07/18/Ceph/" data-id="cjcxbtvaj000e005bgo43w8zz" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://funkygao.github.io/2017/07/18/Ceph/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://funkygao.github.io/2017/07/18/Ceph/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <nav id="page-nav">
        <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
</section>
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">recent</h3>
        <div class="widget">
            <ul id="recent-post" class="no-thumbnail">
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2018/01/18/BigData-related/" class="title">BigData related</a></p>
                            <p class="item-date"><time datetime="2018-01-18T00:44:54.000Z" itemprop="datePublished">2018-01-18</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/12/14/Misc/" class="title">知名公司功能模块的实现笔记</a></p>
                            <p class="item-date"><time datetime="2017-12-14T02:06:48.000Z" itemprop="datePublished">2017-12-14</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/12/11/OtterTune/" class="title">OtterTune</a></p>
                            <p class="item-date"><time datetime="2017-12-11T01:28:11.000Z" itemprop="datePublished">2017-12-11</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/09/28/TimescaleDB/" class="title">TimescaleDB</a></p>
                            <p class="item-date"><time datetime="2017-09-28T00:42:41.000Z" itemprop="datePublished">2017-09-28</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/09/11/block-chain/" class="title">blockchain</a></p>
                            <p class="item-date"><time datetime="2017-09-11T00:25:49.000Z" itemprop="datePublished">2017-09-11</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a><span class="archive-list-count">36</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">42</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tags</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/PubSub/">PubSub</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/">algorithm</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/architecture/">architecture</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cloud/">cloud</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/database/">database</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hacking/">hacking</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/">misc</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/protocol/">protocol</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/storage/">storage</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/一致性/">一致性</a><span class="tag-list-count">9</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tag cloud</h3>
        <div class="widget tagcloud">
            <a href="/tags/PubSub/" style="font-size: 18.75px;">PubSub</a> <a href="/tags/algorithm/" style="font-size: 17.5px;">algorithm</a> <a href="/tags/architecture/" style="font-size: 16.25px;">architecture</a> <a href="/tags/cloud/" style="font-size: 13.75px;">cloud</a> <a href="/tags/database/" style="font-size: 20px;">database</a> <a href="/tags/hacking/" style="font-size: 10px;">hacking</a> <a href="/tags/misc/" style="font-size: 12.5px;">misc</a> <a href="/tags/protocol/" style="font-size: 11.25px;">protocol</a> <a href="/tags/storage/" style="font-size: 17.5px;">storage</a> <a href="/tags/一致性/" style="font-size: 15px;">一致性</a>
        </div>
    </div>

    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            <div class="x2 x2-move">
                <span id="busuanzi_container_page_pv">PV: <span id="busuanzi_value_page_pv"></span></span>
                    <span id="busuanzi_container_site_pv">Site: <span id="busuanzi_value_site_pv"></span></span>
                <span id="busuanzi_container_site_uv">UV: <span id="busuanzi_value_site_uv"></span></span>
            </div>
        </div>
    </div>
</footer>

<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

        
    
    <script>
    var disqus_config = function () {
        
        this.page.identifier = 'undefined';
    };
    (function() { 
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'hexo-theme-icarus' + '.disqus.com/count.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>