<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset="utf-8">
    
    <title>Notes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="website">
<meta property="og:title" content="Notes">
<meta property="og:url" content="http://funkygao.github.io/index.html">
<meta property="og:site_name" content="Notes">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Notes">
    

    
        <link rel="alternate" href="/" title="Notes" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                
                <span class="site-title">Notes</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/images/avatar.jpeg" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/images/avatar.jpeg" />
            <h2 id="name">Funky Gao</h2>
            <h3 id="title">Explore, Solve problems</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Beijing, China</span>
            <a id="follow" target="_blank" href="https://github.com/funkygao/">FOLLOW</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                90
                <span>posts</span>
            </div>
            <div class="article-info-block">
                10
                <span>tags</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="http://github.com/funkygao" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="twitter" class=tooltip>
                            <i class="fa fa-twitter"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="facebook" class=tooltip>
                            <i class="fa fa-facebook"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="dribbble" class=tooltip>
                            <i class="fa fa-dribbble"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="rss" class=tooltip>
                            <i class="fa fa-rss"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main">
    <article id="post-GFS" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/07/25/GFS/">GFS evolution and BigTable</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/07/25/GFS/">
            <time datetime="2017-07-25T06:39:34.000Z" itemprop="datePublished">2017-07-25</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/storage/">storage</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="GFS"><a href="#GFS" class="headerlink" title="GFS"></a>GFS</h2><p>GFS，2001年开发出来，3个人，1年，论文发表于2003<br>BigTable，2003年开发出来，论文发表于2006</p>
<h3 id="master"><a href="#master" class="headerlink" title="master"></a>master</h3><ul>
<li>replicated operation(redo) log with checkpoint to shadow masters<ul>
<li>当时没有自动failover，全是人工操作DNS alias</li>
<li>read请求可以使用shadow masters</li>
<li>生成checkpoint时，master切换到新的redo log file，创建新线程生成checkpoint<br>在此过程中发生的变化，记录到新redo log file</li>
<li>operation log保证了mutation的全局有序</li>
<li>save checkpoint<br>很可能是通过mmap+msync</li>
</ul>
</li>
<li>bottleneck?<ul>
<li>当时部署了多个cluster，根据业务属性<br>最大的超过1000节点，300TB</li>
<li>过高的OPS<br>由于redo log需要复制，master的tps也就在1万左右<ul>
<li>client cache<br>何时invalidate and recall master?<ul>
<li>primary unreachable</li>
<li>primary reponse: no lease</li>
</ul>
</li>
<li>client batch request</li>
<li>lease</li>
</ul>
</li>
<li>内存容量<ul>
<li>prefix compression to reduce memory footprint</li>
<li>每个chunk(64MB)，metadata占内存64B<br>如果保存1百万个文件(64TB)，需要64MB内存<br>如果保存10亿个文件(64PB)，需要64GB内存<br>实际上是到了5千万个文件，10PB的时候，master已经到达瓶颈了</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="metadata"><a href="#metadata" class="headerlink" title="metadata"></a>metadata</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">type metadata &#123;</div><div class="line">    filename string // prefix compression</div><div class="line">    owner uid</div><div class="line">    perm acl</div><div class="line">    chunks []chunk &#123;</div><div class="line">        chunk_id int64</div><div class="line">        version int</div><div class="line">        refCount int // for snapshot COW</div><div class="line">        chunkservers []string // ip addr</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h3><p>rename to hidden file，保留3天，之后真正删除</p>
<h3 id="write-mutation"><a href="#write-mutation" class="headerlink" title="write/mutation"></a>write/mutation</h3><ul>
<li>operation log replicated between master and shadows</li>
<li>client write data flow to pipelined chain chunkservers</li>
<li>primary write control flow to secondary chunkservers</li>
</ul>
<h3 id="read-filename-offset-size"><a href="#read-filename-offset-size" class="headerlink" title="read(filename, offset, size)"></a>read(filename, offset, size)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">client根据(offset, size)计算出需要哪些chunks，假设chunk1, chunk2</div><div class="line">client把(filename, chunk index [1, 2])类似batch一样发送master</div><div class="line">master返回&#123;chunk1: &#123;chunkId1, [ip1, ip2, ip3]&#125;, chunk2: &#123;chunkId2, [ip4, ip5, ip6]&#125;&#125;</div><div class="line">client.putInCache(metadata)</div><div class="line">client顺序地获取chunk1, chunk2</div><div class="line">对于chunk1，根据ip1-3与client ip的距离，找最近的，取chunk；如果失败，找下一个最近的chunkserver</div><div class="line">client.sendToIp1(chunkId1, offset1, size1)</div><div class="line"></div><div class="line">// stale read是存在的，read的时候chunkserver可能发现data corruption</div></pre></td></tr></table></figure>
<h3 id="磁盘错误的解决"><a href="#磁盘错误的解决" class="headerlink" title="磁盘错误的解决"></a>磁盘错误的解决</h3><p>file -&gt; chunk -&gt; block</p>
<p>在每个chunkserver上执行，通过checksum检测</p>
<p>每个chunk由多个64KB的block组成，每个block有一个32位的checksum</p>
<p>read repair，如果chunkserver发现了一个非法block，会返回client err，同时向master汇报</p>
<ul>
<li>client会从其他replica read</li>
<li>master会从其他有效的replica把这整个chunk clone到另外一个chunkserver，然后告诉有问题的chunkserver删除那个chunk</li>
</ul>
<h3 id="Questions"><a href="#Questions" class="headerlink" title="Questions"></a>Questions</h3><h4 id="chunk为什么64MB那么大"><a href="#chunk为什么64MB那么大" class="headerlink" title="chunk为什么64MB那么大?"></a>chunk为什么64MB那么大?</h4><ul>
<li>减少master内存的占用</li>
<li>减少client与master的交互<br>同一个chunk的R/W，client只需要与master交互一次</li>
<li>可以很容易看到机器里哪些机器磁盘快满了，而做迁移</li>
<li>可以减少带宽的hotspot<br>如果没有chunk，那么1TB的文件就只能从一个replica读<br>有了chunk，可以从多个replica读</li>
<li>sharding the load</li>
<li>加快recovery时间<br>每个chunk，可以很快地被clone到一台新机器</li>
<li>如果一个file只有1MB，那么实际存储空间是1MB，而不是64MB<br>但它会增加master file count问题</li>
<li>可以独立replicate<ul>
<li>文件的一部分损坏，可以迅速从好的replica恢复</li>
<li>支持更细粒度的placement</li>
</ul>
</li>
<li>支持超大文件</li>
</ul>
<h4 id="chunk-hotspot问题"><a href="#chunk-hotspot问题" class="headerlink" title="chunk hotspot问题"></a>chunk hotspot问题</h4><p>MapReduce时，需要把代码发布到GFS，很可能小于64MB，即只有1个chunk，当很多mapper时，这个chunkserver就成为hotspot<br>解决办法是：增加replication factor</p>
<p>但最终的解决方案是：client间P2P，互相读</p>
<h4 id="master为什么不用Paxos"><a href="#master为什么不用Paxos" class="headerlink" title="master为什么不用Paxos?"></a>master为什么不用Paxos?</h4><p>master通过redo log sync replication来提高可靠性，但没有election过程，都是完全手工进行failover</p>
<p>我猜，chubby当时还没有启动，chubby论文发表于2006</p>
<h4 id="master为什么不持久化chunk-location"><a href="#master为什么不持久化chunk-location" class="headerlink" title="master为什么不持久化chunk location?"></a>master为什么不持久化chunk location?</h4><p>其他的metadata是有redo log replication并持久化的，他们的变化，都是主动产生的，例如创建一个文件，增加一个chunk<br>而由于chunkserver随时可能crash，不受控制，因此通过heartbeat来计算并存放内存，通过heartbeat，master又可以修正chunkserver的一些错误，例如orphan chunk</p>
<h4 id="Data-flow为什么pipelined-chain，而不并发"><a href="#Data-flow为什么pipelined-chain，而不并发" class="headerlink" title="Data flow为什么pipelined chain，而不并发?"></a>Data flow为什么pipelined chain，而不并发?</h4><p>为了避免产生网络瓶颈，同时为了更充分利用high latency links<br>通过ip地址，感知chunkserver直接的距离</p>
<p>Total Latency = (B/T) + (R*L)</p>
<p>2PC，避免了client(coordinator) crash问题，因为primary成为了coordinator，而它是有failover的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">client负责把一个write请求分成多个chunk的请求</div><div class="line"></div><div class="line">Phase1: data flow  client -&gt; chained chunkservers</div><div class="line">相当于prepare，但数据不落盘</div><div class="line">client由近及远地chain把数据写入相应chunkserver的LRU buffer</div><div class="line">这个顺序跟primary在哪无关</div><div class="line"></div><div class="line">Phase2: control flow  client -&gt; primary -&gt; secondary chunkservers</div><div class="line">相当于commit，数据visible</div><div class="line">确定mutation order</div><div class="line"></div><div class="line">Phase1出错，则等master来修复，把crashed chunkserver摘除</div><div class="line">Phase2出错，primary-&gt;secondary，这个阶段，那么primary返回client err，client会重试，此时可能出现不一致的状态，但最终master会修复</div></pre></td></tr></table></figure></p>
<h4 id="为什么搞个primary角色，而不让master做"><a href="#为什么搞个primary角色，而不让master做" class="headerlink" title="为什么搞个primary角色，而不让master做?"></a>为什么搞个primary角色，而不让master做?</h4><p>为了减轻master负担，所以搞了个二级调度:<br>跨chunk，master负责；chunk内部，primary负责</p>
<h4 id="master如何revoke-primary-lease"><a href="#master如何revoke-primary-lease" class="headerlink" title="master如何revoke primary lease?"></a>master如何revoke primary lease?</h4><p>在lease expire后，master可能什么都不做<br>在lease expire前，master会sendto(primary)让它取消；如果sendto失败，那么只能等expire</p>
<h4 id="为什么data-flow和control-flow分开"><a href="#为什么data-flow和control-flow分开" class="headerlink" title="为什么data flow和control flow分开?"></a>为什么data flow和control flow分开?</h4><p>如果不分开，那么所有的数据都是client-&gt;primary-&gt;secondary<br>分开后，比较轻量级的control flow必须走primary扩散；重量级的data flow可以根据物理拓扑进行优化</p>
<h2 id="GFS-vs-Ceph"><a href="#GFS-vs-Ceph" class="headerlink" title="GFS vs Ceph"></a>GFS vs Ceph</h2><ul>
<li>论文2003 vs 2006</li>
<li>chunk(64MB) vs Object(4MB)<br>object size可配</li>
<li>master vs mon(Paxos)</li>
<li>chunkserver vs osd</li>
<li>replication<ul>
<li>GFS<br>2PC, decouple data/control flow</li>
<li>Ceph<br>client &lt;-&gt; osd</li>
</ul>
</li>
<li>Ceph通过PG+crunch提高了扩展性<br>GFS通过allocation table的方式</li>
<li>GFS上直接跑MapReduce<br>计算向存储locality</li>
<li>Ceph更通用，latency更好<br>GFS通过lease提高扩展性，但遇到错误时只能等expire</li>
<li>节点的变化<ul>
<li>GFS<br>chunkserver向master汇报，自动加入，完全不需要人工参与</li>
<li>Ceph<br>需要通过ceph osd命令，手工执行</li>
</ul>
</li>
<li>namespace<br>GFS是directory，Ceph是flat object id</li>
</ul>
<h2 id="2009-GFS回顾"><a href="#2009-GFS回顾" class="headerlink" title="2009 GFS回顾"></a>2009 GFS回顾</h2><p>GFS在使用了10年的过程中，发现了一些问题，对这些问题，有的是通过上层的应用来解决的，有的是修改GFS解决的</p>
<h3 id="master-ops压力"><a href="#master-ops压力" class="headerlink" title="master ops压力"></a>master ops压力</h3><p>最开始的设计，考虑的是支撑几百TB，几百万个文件。但很快，到了几十PB，这对master有了压力</p>
<ul>
<li>master在recover的时候，也变慢</li>
<li>master要维护的数据更多</li>
<li>client与master的交互变慢<br>每次open，client都要请求master<br>MapReduce下，可能突然多出很多task，每个都需要open，master处理能力也就是每秒几千个请求<br>解决办法是在应用层垂直切分，弄多个cluster，应用通过静态的NameSpace找自己的master，同时提升单个master能力到数万ops</li>
</ul>
<p>随着GFS的内部推广，越来越多的千奇百怪的上层应用连接进来</p>
<ul>
<li>最开始是爬虫和索引系统</li>
<li>然后QA和research组用GFS来保存large data sets</li>
<li>再然后，就有50多个用户了</li>
<li>在此过程中GFS不断地调整以满足新use case</li>
</ul>
<h3 id="file-count问题"><a href="#file-count问题" class="headerlink" title="file-count问题"></a>file-count问题</h3><p>很早就发现了，例如：</p>
<ul>
<li>前端机上要把log发到GFS保存以便MapReduce分析，前端机很多，每个log每天会logrotate，log的种类也越来越多</li>
<li>gmail需要保存很多小文件<br>解决办法是把多个文件合并，绕开file-count问题，同时增加quota功能，限制file-count和storage space<br>长远的办法：在开发distributed multi-master系统，一个cluster可以有上百个master，每个master可以存1亿个文件，但<br>如果都是小文件，会有新的问题出现：more seek<br>再后来，建立在GFS之上的BigTable推出了，帮助GFS直接面对应用对小文件、多文件的需求，BigTable层给解决了，BigTable在使用GFS时，仍然是大文件、少文件</li>
</ul>
<h3 id="latency问题"><a href="#latency问题" class="headerlink" title="latency问题"></a>latency问题</h3><p>GFS设计是只考虑吞吐率，而少考虑latency</p>
<h4 id="error-recovery慢"><a href="#error-recovery慢" class="headerlink" title="error recovery慢"></a>error recovery慢</h4><p>如果write一个文件，需要写到3个chunkserver，如果其中一个卡住了或crash，master会发觉(heartbeat)，它会开新的一个chunkserver replica从其他chunkserver pull<br>master会把这个lock，以便新的client不能write(等恢复后再unlock)<br>而这个pullchunk操作，为了防止bandwidth burst，是有throttle的，限制在5-10MB/s，即一个64MB chunk，需要10s左右<br>等恢复到3个ok的时候再返回给client，client再继续write<br>在此过程中，client一直是block的</p>
<h4 id="master-failover慢"><a href="#master-failover慢" class="headerlink" title="master failover慢"></a>master failover慢</h4><p>刚开始master failover完全靠人工，可能需要1h；后来增加了自动master failover，需要几分钟；再改进，可以在几秒钟内完成master自动切换</p>
<h4 id="为吞吐量而设计的batch增加latency"><a href="#为吞吐量而设计的batch增加latency" class="headerlink" title="为吞吐量而设计的batch增加latency"></a>为吞吐量而设计的batch增加latency</h4><h4 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h4><p>BigTable是无法忍受那么高的延时的，它的transaction log是最大的瓶颈，存储在GFS：<br>2个log(secondary log)，一个慢，就切换到另外一个，这2个log任意时刻只有1个active，并且log entry里有sequence号，以便replay时防重<br>google使用这个request redundancy or timeout方法很广泛，为了解决search long tail latency，一样思路</p>
<p>Gmail是多机房部署的，一个卡了，切到另外机房</p>
<h3 id="consistency"><a href="#consistency" class="headerlink" title="consistency"></a>consistency</h3><p>client一直push the write till it succeeds<br>但如果中途client crash了，会造成中间状态：不同client读同一个文件，可能发现文件长度不同<br>解决办法：使用append，offset统一由primary管理</p>
<p>但append由于没有reply保护机制，也有问题：<br>client write，primary分配一个offset，并call secondary，有的secondary收到有的没收到，此时primary crash<br>master会选另外一个作为primary，它可能会分配一个新的offset，造成该数据重复<br>如果为此再设计一套consensus，得不偿失<br>解决办法：single writer，让上层应用保证不并发写</p>
<h2 id="Colossus"><a href="#Colossus" class="headerlink" title="Colossus"></a>Colossus</h2><p>Colossus is specifically designed for BigTable, 没有GFS那么通用<br>In other words, it was built specifically for use with the new Caffeine search-indexing system, and though it may be used in some form with other Google services, it is not the sort of thing that is designed to span the entire Google infrastructure.</p>
<ul>
<li>automatically sharded metadata layer</li>
<li>EC</li>
<li>client driven replication</li>
<li>metadata space has enabled availability analysis</li>
</ul>
<h2 id="BigTable"><a href="#BigTable" class="headerlink" title="BigTable"></a>BigTable</h2><p><img src="https://github.com/funkygao/blogassets/blob/master/img/bigtable.jpg?raw=true" alt="(row, column, time) -&gt; value"></p>
<p>在有了GFS和Chubby后，Google就可以在上面搭建BigTable了，一个GFS的索引服务<br>但BigTable论文对很多细节都没有提到：SSTable的实现、tabletserver的HA，B+数的metadata table算法</p>
<p>为了管理巨大的table，按照row key做sharding，每个shard称为tablet(100-200MB，再大就split)，每台机器存储100-1000个tablet<br>row key是一级索引，column是二级索引，版本号(timestamp)是三级索引</p>
<p><img src="https://github.com/funkygao/blogassets/blob/master/img/tablet-write.png?raw=true" alt="redo log和SSTable都存放在GFS的Chubby管理元信息的分布式LSM Tree"></p>
<p>tabletserver没有任何的持久化数据，只是操作memtable，真正的数据存放在哪里只有GFS知道，那为什么需要master在chubby上分配tablet给tabletserver?<br>因为memtable是有状态的: level0</p>
<p>tabletserver的HA?<br>通过chubby ephemeral node，死了master会让别的server接管，通过GFS上的redo log恢复memtable<br>为了保证强一致性系统，同一时刻同一份数据只能一台tabletserver服务，tabletserver对每个tablet是没有备份的<br>当它crash，由于只需要排序很少的操作日志并且加载服务的tablet的索引，宕机恢复可以做到一分钟以内；在此期间，一部分rowkey不可用</p>
<p>split and migration?<br>在没有crash情况下，只需要修改metadata和从sstable加载索引数据，效率很高</p>
<h3 id="与GFS的对应"><a href="#与GFS的对应" class="headerlink" title="与GFS的对应"></a>与GFS的对应</h3><ul>
<li>commit log<br>每台机器一个commit log文件，与GFS File一一对应</li>
<li>sstable<br>HBase中Column Family的名称会被作为文件系统中的目录名称，每个CF存储成一个HDFS的HFile<br>据google工作过的人说：Column Families are stored in their own SSTable，应该是这样<br>sstable对应一个GFS File<br>sstable block=64KB，它与GFS的block相同<br>sstable block为了压缩和索引(binary search)，GFS block为了checksum</li>
</ul>
<h3 id="Highlights"><a href="#Highlights" class="headerlink" title="Highlights"></a>Highlights</h3><h4 id="redo-log合并"><a href="#redo-log合并" class="headerlink" title="redo log合并"></a>redo log合并</h4><p>一台机器一个redo log，而不是一个tablet一个redo log(每个机器有100-1000个tablet)，否则GFS受不了<br>group commit</p>
<p>带来的问题：恢复时麻烦了<br>如果一天机器crash了，它上面的tablets会被master分配到很多其他的tabletserver上<br>例如，分配到了100台新tabletserver，他们都会read redo log and filter，这样redo log被读了100次<br>解决办法：利用类似MapReduce机制，在recovery之前先给redo log排序 <table, rowkey,="" log="" sequence="" number=""></table,></p>
<h4 id="加速tablet迁移"><a href="#加速tablet迁移" class="headerlink" title="加速tablet迁移"></a>加速tablet迁移</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sourceTablet.miniorCompaction() // 把memtable里内容dump到GFS的SSTable</div><div class="line">sourceTablet.stopServe()</div><div class="line">sourceTablet.miniorCompaction() // 把in-flight commit log对应的操作也持久化到GFS</div><div class="line">                                // 这样targetTablet就不需要从commit log recover了</div><div class="line">master.doSwitch()</div></pre></td></tr></table></figure>
<h4 id="SSTable由多个64KB的block组成"><a href="#SSTable由多个64KB的block组成" class="headerlink" title="SSTable由多个64KB的block组成"></a>SSTable由多个64KB的block组成</h4><p>压缩以block为单位，虽然相比在整个SSTable上压缩比小(浪费空间)，但对于随机读，可以只uncompress block而非整个SSTable</p>
<h3 id="经验和教训"><a href="#经验和教训" class="headerlink" title="经验和教训"></a>经验和教训</h3><p>遇到了新的问题</p>
<ul>
<li>发现了Chubby的bug</li>
<li>network corruption<br>通过给RPC增加checksum解决</li>
<li>delay adding features until clear how it will be used<br>刚开始想给API增加一个通用的事务机制，后来发现大部分人只需要单行事务</li>
<li>不仅监控server，也监控client<br>扩展了RPC，采样detailed trace of important actions</li>
<li>设计和实现都要简单、明了<br>BigTable代码10万行C++<br>tabletserver的membership协议的设计，最初：master给tabletserver发lease<br>结果：在网络出问题时大大降低了可用性(master无法reach tabletserver就只能等expire)<br>改进：实现了更复杂的协议，也利用了Chubby里非常少见的特性<br>结果：大量时间在调试edge case，很多时间在调试Chubby的代码<br>最终：回到简单的设计，只依赖Chubby，而且只使用它通用的特性</li>
</ul>
<h3 id="Questions-1"><a href="#Questions-1" class="headerlink" title="Questions"></a>Questions</h3><p>按照rowkey来shard，那么可能造成hotspot问题，client端比较难控制</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="http://queue.acm.org/detail.cfm?id=1594206" target="_blank" rel="external">http://queue.acm.org/detail.cfm?id=1594206</a><br><a href="http://google-file-system.wikispaces.asu.edu/" target="_blank" rel="external">http://google-file-system.wikispaces.asu.edu/</a><br><a href="http://static.usenix.org/publications/login/2010-08/openpdfs/maltzahn.pdf" target="_blank" rel="external">http://static.usenix.org/publications/login/2010-08/openpdfs/maltzahn.pdf</a><br><a href="https://stephenholiday.com/notes/bigtable/" target="_blank" rel="external">https://stephenholiday.com/notes/bigtable/</a></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://funkygao.github.io/2017/07/25/GFS/" data-id="cj5nhpoh8000svb5bq0u06ogh" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://funkygao.github.io/2017/07/25/GFS/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://funkygao.github.io/2017/07/25/GFS/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-replication" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/07/19/replication/">replication models</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/07/19/replication/">
            <time datetime="2017-07-19T11:12:26.000Z" itemprop="datePublished">2017-07-19</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/storage/">storage</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="Models"><a href="#Models" class="headerlink" title="Models"></a>Models</h2><ul>
<li>primary-replica(failover, replica readable)/multi-master/chain</li>
<li>replica/ec</li>
<li>push/pull</li>
<li>sync/async</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Dynamo      PUSH coordinator -&gt; preference list next nodes in hash ring</div><div class="line">Raft/ZK     PUSH master commit log -&gt; majority ack</div><div class="line">GFS/Hadoop  chain replication</div><div class="line">ES          PUSH primary-replica model, master concurrently dispatch index req to all replicas</div><div class="line">MySQL       PUSH master async PUSH to slaves binlog</div><div class="line">Kafka       PULL(Fetch) ISR</div><div class="line">redis</div><div class="line">Ceph        PUSH primary-replica sync model with degrade mode 同步写入</div><div class="line">Swift</div><div class="line">Aurora      PUSH primary instance R(3)+W(4)&gt;N(6)</div></pre></td></tr></table></figure>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://funkygao.github.io/2017/07/19/replication/" data-id="cj5nhpojm004rvb5b08ud4khd" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://funkygao.github.io/2017/07/19/replication/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://funkygao.github.io/2017/07/19/replication/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-Google-container-evolution" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/07/19/Google-container-evolution/">Google container evolution</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/07/19/Google-container-evolution/">
            <time datetime="2017-07-19T01:45:30.000Z" itemprop="datePublished">2017-07-19</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/cloud/">cloud</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>Babbysitter &amp; GlobalWorkQueue -&gt; cgroup -&gt; Borg -&gt; Omega -&gt; Kubernetes</p>
<h2 id="Container"><a href="#Container" class="headerlink" title="Container"></a>Container</h2><p>容器提供的隔离还不完善，OS无法管理的，容器无法隔离(例如CPU Cache，内存带宽)，为了防止(cloud)恶意用户，需要在容器外加一层VM保护</p>
<p>container = isolation + image</p>
<p>数据中心：机器为中心 -&gt; 应用为中心<br>在Application与OS之间增加一层抽象：container<br>container的依赖大部分都存放在image了，除了OS的系统调用<br>实际上，应用仍然会受OS影响，像/proc, ioctl</p>
<h3 id="好处"><a href="#好处" class="headerlink" title="好处"></a>好处</h3><ul>
<li>更高的资源利用率</li>
<li>监控的是应用，而不是混在一起的机器</li>
<li>开发者、管理员不需关心OS</li>
<li>load balancer不再balance traffic across machines: across application instances</li>
<li>logs are keyed by application, not machine</li>
<li>可以更容易识别是应用的失败还是机器的失败</li>
</ul>
<h2 id="教训"><a href="#教训" class="headerlink" title="教训"></a>教训</h2><ul>
<li>不要给container端口号<br>Borg做法是物理机上的所有容器共用主机的ip，每个容器分单独的端口号<br>Kubernetes为每个pod分配不同ip，network身份=application身份</li>
<li>不要给container编号<br>用label</li>
<li>不用暴露raw state<br>减少client端的复杂度<br>K8s里，都通过API Service访问状态信息</li>
</ul>
<h2 id="还没有很好解决的问题"><a href="#还没有很好解决的问题" class="headerlink" title="还没有很好解决的问题"></a>还没有很好解决的问题</h2><ul>
<li>Configuration</li>
<li>Dependency management<br>手工配，最终一定不一致<br>自动，无法获取足够的语义信息</li>
</ul>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://funkygao.github.io/2017/07/19/Google-container-evolution/" data-id="cj5nhpoh9000uvb5bv08rb5cl" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://funkygao.github.io/2017/07/19/Google-container-evolution/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://funkygao.github.io/2017/07/19/Google-container-evolution/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-Ceph" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/07/18/Ceph/">Ceph Internals</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/07/18/Ceph/">
            <time datetime="2017-07-18T07:27:20.000Z" itemprop="datePublished">2017-07-18</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/storage/">storage</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="RADOS"><a href="#RADOS" class="headerlink" title="RADOS"></a>RADOS</h2><h3 id="Key-ideas"><a href="#Key-ideas" class="headerlink" title="Key ideas"></a>Key ideas</h3><p><img src="https://github.com/funkygao/blogassets/blob/master/img/ceph.png?raw=true" alt="components"></p>
<ul>
<li>把传统文件系统架构分隔成client component and storage component<br>client负责更上层的抽象(file, block, object)，storage负责底层object, disk</li>
<li>seperation of data and metadata<br>各管各的</li>
</ul>
<h3 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h3><p>Object是最终落地存储文件的基本单位，可以类比fs block，默认4MB<br>如果一个文件 &gt; object size，文件会被stripped，这个操作是client端完成的</p>
<p>It does not use a directory hierarchy or a tree structure for storage<br>It is stored in a flat-address space containing billions of objects without any complexity</p>
<p>Object组成</p>
<ul>
<li>key</li>
<li>value<br>在fs里用一个文件存储</li>
<li>metadata<br>可以存放在扩展的fs attr里<br>因此对底层文件系统是有要求的，ext4fs对extended attr数量限制的太少，可以用xfs</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">  +---logical------+       +--physical layer -+</div><div class="line">  |                |       |                  |</div><div class="line">cluster -&gt; pool -&gt; pg ---&gt; osd -&gt; object -&gt; fs files</div><div class="line">                   |       |                 </div><div class="line">                   +-crush-+</div></pre></td></tr></table></figure>
<h3 id="Lookup"><a href="#Lookup" class="headerlink" title="Lookup"></a>Lookup</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">file = ino</div><div class="line">obj = (ino, ono)</div><div class="line">obj_hash = hash(ino, ono)</div><div class="line">pg = obj_hash &amp; (num_pg-1) // num_pg是2整数幂，例如codis里1024</div><div class="line">                           // 官方推荐num_pg是osd总数的数百倍</div><div class="line">                           // num_pg如果变化，会引起大量的数据迁移</div><div class="line">osds_for_pg = crush(pg)    // list of osds，此处是唯一需要全局cluster map的地方</div><div class="line">                           // 其他的，都是算出来的</div><div class="line">                           // osds_for_pg is ordered，len(osds_for_pg)=replicate factor</div><div class="line">primary = osds_for_pg[0]</div><div class="line">replicas = osds_for_pg[1:]</div></pre></td></tr></table></figure>
<p><img src="https://github.com/funkygao/blogassets/blob/master/img/ceph-lookup.png?raw=true" alt="lookup"></p>
<h3 id="crush"><a href="#crush" class="headerlink" title="crush"></a>crush</h3><p>一个hash算法，目标</p>
<ul>
<li>数据均匀的分布到集群中</li>
<li>需要考虑各个OSD权重的不同（根据读写性能的差异，磁盘的容量的大小差异等设置不同的权重）</li>
<li>当有OSD损坏需要数据迁移时，数据的迁移量尽可能的少</li>
</ul>
<p>有点像一致性哈希：failure, addition, removal of nodes result in near-minimal object migration</p>
<p><img src="https://github.com/funkygao/blogassets/blob/master/img/ceph-crush.png?raw=true" alt="crush"></p>
<h3 id="PG"><a href="#PG" class="headerlink" title="PG"></a>PG</h3><p>PG(placement group)与Couchbase里的vbucket一样，codis里也类似，都是presharding技术</p>
<p>在object_id与osd中间增加一层pg，减少由于osd数量变化造成大量的数据迁移<br>PG使得文件的定位问题，变成了通过crush定位PG的问题，数量大大减少<br>例如，1万个osd，100亿个文件，30万个pg: 100亿 vs 30万</p>
<p>线上尽量不要更改PG的数量，PG的数量的变更将导致整个集群动起来（各个OSD之间copy数据），大量数据均衡期间读写性能下降严重</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Total PGs = (Total_number_of_OSD * 100) / max_replication_count</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ceph osd map pool1 object1</div><div class="line">osdmap e566 pool &apos;pool1&apos; (10) object &apos;object1&apos; -&gt; pg 10.bac4decb (10.3c) -&gt; up [0,6,3] acting [0,6,3]</div><div class="line">$</div><div class="line">// osdmap e566: osd map epoch 566</div><div class="line">// pool &apos;pool1&apos; (10): pool name and pool id，pool id从0开始，每新建+1</div><div class="line">// pg 10.bac4decb (10.3c): placement group number 10.3c(pg id是16进制，256个pg，那么他们的id: 0, 1, f, fe, ff)</div><div class="line">                           pg id实际上是pool_id.pg_id(pool id=10, pg id=3c)</div><div class="line">// up [0,6,3]: osd up set contains osd.0, osd.6, osd.3</div></pre></td></tr></table></figure>
<p>同一个PG内的osd通过heartbeat相互检查对方状态，大部分情况下不需要mon参与，减少了mon负担</p>
<h3 id="mon"><a href="#mon" class="headerlink" title="mon"></a>mon</h3><p>相当于Ceph的zookeeper</p>
<p>mon quorum负责整个Ceph cluster中所有OSD状态(cluster map)，然后以增量、异步、lazy方式扩散到each OSD和client<br>mon被动接收osd的上报请求，作为reponse把cluster map返回，不主动push cluster map to osd<br>如果client和它要访问的PG内部各个OSD看到的cluster map不一致，则这几方会首先同步cluster map，然后即可正常访问</p>
<p>MON跟踪cluster状态：OSD, PG, CRUSH maps<br>同一个PG的osd除了向mon发送心跳外，还互相发心跳以及坚持pg数据replica是否正常</p>
<h3 id="Replication"><a href="#Replication" class="headerlink" title="Replication"></a>Replication</h3><p>是primary-replica model, 强一致性，读和写只能向primary发起请求<br><img src="https://github.com/funkygao/blogassets/blob/master/img/ceph-rw.png?raw=true" alt="read write"><br><img src="https://github.com/funkygao/blogassets/blob/master/img/ceph-rw1.jpg?raw=true" alt="read write"><br>其中replicas在复制到buffer时就ack，如果某个replica复制时失败，进入degrade状态</p>
<h3 id="2PC-Write"><a href="#2PC-Write" class="headerlink" title="2PC Write"></a>2PC Write</h3><p><img src="https://github.com/funkygao/blogassets/blob/master/img/ceph-2pc.png?raw=true" alt="write 2PC"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">phase1: client从primay接收ack</div><div class="line">此时，数据已经replicate到每个replica的内存</div><div class="line"></div><div class="line">phase2: client从primary接收commit</div><div class="line">此时，数据已经replicate到每个replica的磁盘</div><div class="line">client才把本地的write buffer cache清除</div></pre></td></tr></table></figure>
<h3 id="scrub机制"><a href="#scrub机制" class="headerlink" title="scrub机制"></a>scrub机制</h3><p>read verify</p>
<h2 id="Questions"><a href="#Questions" class="headerlink" title="Questions"></a>Questions</h2><h3 id="consistency"><a href="#consistency" class="headerlink" title="consistency?"></a>consistency?</h3><p>strongly consistent</p>
<h3 id="Can-Ceph-replace-facebook-Haystack"><a href="#Can-Ceph-replace-facebook-Haystack" class="headerlink" title="Can Ceph replace facebook Haystack?"></a>Can Ceph replace facebook Haystack?</h3><p>Haystack解决的实际上是metadata访问造成的IO问题，解决的方法是metadata完全内存，无IO<br>每个图片的read，需要NetApp进行3次IO: dir inode, file inode, file data<br>haystack每个图片read，需要1次IO，metadata保证在内存<br>在一个4TB的SATA盘存储20M个文件，每个inode如果需要500B，那么如果inode都存放内存，需要10GB内存</p>
<ul>
<li>减少每个metadata的大小<br>去掉大部分不需要的数据，例如uid, gid, atime等<br>xfs里每个metadata占536字节，haystack每个图片需要10字节</li>
<li>减少metadata的总数量<br>多个图片(needle)合并进一个大文件(superblock)</li>
</ul>
<p>用户上传一张图片，facebook会将其生成4种尺寸的图片，每种存储3份，因此写入量是用户上传量的12倍。</p>
<p>Posix规范里的metadata很多对图片服务器不需要，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">struct inode &#123;</div><div class="line">    loff_t              i_size;  // 文件大小</div><div class="line">    struct list_head    i_list;  // backing dev IO list</div><div class="line">    struct list_head    i_devices;</div><div class="line">    blkcnt_t            i_blocks;</div><div class="line">    struct super_block  *i_sb;</div><div class="line">    struct timespec     i_atime;</div><div class="line">    struct timespec     i_mtime;</div><div class="line">    struct timespec     i_ctime;</div><div class="line">    umode_t             i_mode;</div><div class="line">    uid_t               i_uid;</div><div class="line">    gid_t               i_gid;</div><div class="line">    dev_t               i_rdev;</div><div class="line">    unsigned int        i_nlink;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Ceph解决了一个文件到分布式系统里的定位问题(crush(pg))，但osd并没有解决local store的问题: 如果一个osd上存储过多文件(例如10M)，性能会下降明显</p>
<h3 id="Why-EC-is-slow"><a href="#Why-EC-is-slow" class="headerlink" title="Why EC is slow?"></a>Why EC is slow?</h3><p>Google Colossus采用的是(6,3)EC，存储overhead=(6+3)/6=150%<br>把数据分成6个data block+3个parity block，恢复任意一个数据块需要6个I/O<br>生成parity block和恢复数据时，需要进行额外的encode/decode，造成性能损失</p>
<h3 id="Store-small-file-waste-space"><a href="#Store-small-file-waste-space" class="headerlink" title="Store small file, waste space?"></a>Store small file, waste space?</h3><p>object size是可以设置的</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="http://ceph.com/papers/weil-crush-sc06.pdf" target="_blank" rel="external">http://ceph.com/papers/weil-crush-sc06.pdf</a><br><a href="http://ceph.com/papers/weil-rados-pdsw07.pdf" target="_blank" rel="external">http://ceph.com/papers/weil-rados-pdsw07.pdf</a><br><a href="http://ceph.com/papers/weil-ceph-osdi06.pdf" target="_blank" rel="external">http://ceph.com/papers/weil-ceph-osdi06.pdf</a><br><a href="http://www.xsky.com/tec/ceph72hours/" target="_blank" rel="external">http://www.xsky.com/tec/ceph72hours/</a><br><a href="https://blogs.rdoproject.org/6427/ceph-and-swift-why-we-are-not-fighting" target="_blank" rel="external">https://blogs.rdoproject.org/6427/ceph-and-swift-why-we-are-not-fighting</a><br><a href="https://users.soe.ucsc.edu/~elm/Papers/sc04.pdf" target="_blank" rel="external">https://users.soe.ucsc.edu/~elm/Papers/sc04.pdf</a></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://funkygao.github.io/2017/07/18/Ceph/" data-id="cj5nhpogw000cvb5bl91322ey" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://funkygao.github.io/2017/07/18/Ceph/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://funkygao.github.io/2017/07/18/Ceph/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-Dynamo-flaw" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/07/18/Dynamo-flaw/">Dynamo - A flawed architecture</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/07/18/Dynamo-flaw/">
            <time datetime="2017-07-18T00:35:12.000Z" itemprop="datePublished">2017-07-18</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/architecture/">architecture</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="Author"><a href="#Author" class="headerlink" title="Author"></a>Author</h2><p>Joydeep Sen Sarma，印度人，07-11在facebook担任Data Infrastructure Lead，目前在一个创业公司任CTO<br>在facebook期间，从0搭建了数千节点的hadoop集群，也是Cassandra的core committer，参与开发Hive<br><a href="https://www.linkedin.com/in/joydeeps/" target="_blank" rel="external">https://www.linkedin.com/in/joydeeps/</a></p>
<p>编写在2009年，Dynamo paper发布于2007</p>
<h2 id="‘Flaws’"><a href="#‘Flaws’" class="headerlink" title="‘Flaws’"></a>‘Flaws’</h2><h3 id="R-W-gt-N"><a href="#R-W-gt-N" class="headerlink" title="R+W&gt;N"></a>R+W&gt;N</h3><p>作者主要以Cassandra的实现来评论Dynamoc论文，从而忽略了vector clock逻辑时钟来跟踪数据版本号来检测数据冲突<br>因此，遭到很多围观群众的声讨</p>
<p>作者的主要思想是：由于hinted handoff，缺少central commit log，缺少resync/rejoin barrier，transient failure会导致stale read</p>
<p>Cassandra解决办法，是尝试通过central commit log，那就变成了Raft了<br><a href="https://issues.apache.org/jira/browse/CASSANDRA-225" target="_blank" rel="external">https://issues.apache.org/jira/browse/CASSANDRA-225</a></p>
<p>作者如果提到下面的场景，可能更有说服力<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">// W=3 R=3 N=5(1,2,3,4,5)</div><div class="line"></div><div class="line">Op            W           R</div><div class="line">====        =====       =====</div><div class="line">a=5         1,2,3   </div><div class="line">                        3,4,5 // 由于有节点overlap，写入的数据可以读出来</div><div class="line">2,3crash    </div><div class="line">del(a)      1,4,5</div><div class="line">2,3recover</div><div class="line">                        1,2,3 // 2,3读出a=5，而1没有key(a)，如何处理冲突?</div></pre></td></tr></table></figure></p>
<p>此外，由于sloppy quorum，下面的场景R+W&gt;N也一样无法保证一致性<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">// W=3 R=3 N=5(1,2,3,4,5)</div><div class="line">ring(A, B, C, D, E, F, G, A)</div><div class="line"></div><div class="line">client set(k1)=3 // md5(k1)，发现它的coordinator是A，client send req to A</div><div class="line">A会先写本地磁盘，然后并发向B,C复制，成功后，return to client ok</div><div class="line">现在A, B, C全部crash</div><div class="line">set(k1)=8 // 由于hinted handoff，它的coordinator变成D</div><div class="line">D写盘、复制到E,F，ok。// 当然D,E,F里的数据有hint metadata，表示他们只是代替A,B,C</div><div class="line">                   // 等A,B,C活，再transfer to them and cleanup local store</div><div class="line">然后A, B, C全部recover</div><div class="line">get(k1)，读到是3，而不是8</div><div class="line">// 因为D,E,F的检测A/B/C活以及transfer hinted data是异步的</div></pre></td></tr></table></figure></p>
<h3 id="WAN"><a href="#WAN" class="headerlink" title="WAN"></a>WAN</h3><p>如果一个node crash，’hinted handoff’会把数据写入一致性哈希环上的下一个node：可能是另外一个DC node<br>等crashed node恢复，如果网络partitioned，这个node会很久无法赶上数据，直到partition解除</p>
<p>但preference list里，已经考虑到了，每个key都会复制到不同的机房</p>
<h3 id="论文里的”facts”"><a href="#论文里的”facts”" class="headerlink" title="论文里的”facts”"></a>论文里的”facts”</h3><ul>
<li>论文提到，商业系统通常通过同步复制保证一致性<br>大部分数据库的复制都是异步的</li>
<li>论文提到，中心化架构降低availability<br>不对，中心化会造成扩展瓶颈，并不会降低可用性，SPOF有非常多的方法解决</li>
</ul>
<h2 id="Werner-Vogels的回复"><a href="#Werner-Vogels的回复" class="headerlink" title="Werner Vogels的回复"></a>Werner Vogels的回复</h2><p>Dynamo SOSP论文有2个目的</p>
<ul>
<li>展示如何利用多种技术创建一个生产系统</li>
<li>对学术界的一个反馈，学术到生产环境遇到的困难和解决办法</li>
</ul>
<p>本论文不是一个blueprint，拿它就可以做出一个Dynamo clone的</p>
<p>我认为我的论文真正的贡献，是让人设计系统时的权衡trade-off</p>
<h2 id="Dynamo回顾"><a href="#Dynamo回顾" class="headerlink" title="Dynamo回顾"></a>Dynamo回顾</h2><p>Java实现的，通过md5(key)进行partition，由coordinator node复制read/write/replicate到一致性哈希虚拟节点环上<br>gossip进行membership管理和健康检查，提出了R/W/N的quorum模式</p>
<ul>
<li>no updates are rejected due to failures or concurrent writes</li>
<li>zero-hop DHT<br>为了latency，每个node有全局的路由信息，不产生hop</li>
<li>resolve update conflicts，在read时由应用做，write时不检测<ul>
<li>这与大部分系统相反，原因是为了always writeable</li>
<li>read时，让应用处理冲突，而不是Dynamo store做<br>store做，由于抽象层，只能简单的类似last win的策略<br>应用更懂，可以做类似union等高级处理策略</li>
</ul>
</li>
<li>md5(key) =&gt; target nodes<br>hash conflict? 可以不用考虑，无非就是让一台机器多处理了一个key而已</li>
<li>vector clock<br>[(node, counter), (node, counter), …]<br>get(key)返回的ctx，在put(key, ctx, val)时会带过去：ctx里包含该key的vector clock信息</li>
<li>R W N<br>get/put latency都取决于R/W里最慢节点的latency</li>
<li>get(key)<br>如果没有冲突，返回一个值；发现冲突，返回list<br>返回的每个value都有对应的一个context(vector clock version)</li>
<li>replication<ul>
<li>write coordinator<br>put(key, ctx, val)根据md5(key)计算出coordinator node，它负责写入本地磁盘，同时向顺时针后面的N-1个alive节点进行复制<br>由于后面N-1节点可能come and go，它是动态的，coordinator盲目地找出后面活着的：这样才能有高可用 sloppy quorum</li>
</ul>
</li>
<li>coordinator and replication<br>负责生成新的vector clock，并把(key, val, vc)写入本地<br>同时向顺时针后面的N-1个healthy节点进行复制(dead nodes跳过)<br>但由于虚拟节点的存在，需要保证复制到的节点不在一台机器上<br>preference list是一个key对应的storage node，在ring上，如果顺时针发现有机器重叠就忽略并继续顺时针找</li>
<li>节点的加入和退出<br>手动显示</li>
<li>local persistence engine<br>插件架构，amazon主要使用的是BerkelayDB，但也可以使用mysql/BDB Java等</li>
<li>SLA<br>99.9% 300ms</li>
</ul>
<h3 id="Replication"><a href="#Replication" class="headerlink" title="Replication"></a>Replication</h3><p>每个key都被复制在N台机器(其中一台是coordinator)，coordinator向顺时针方向的N-1个机器复制<br>preference list is list of nodes that is responsible for storing a particular key，通常&gt;N，它是通过gossip在每个节点上最终一致<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">okN = 0</div><div class="line">for node = range preferenceList &#123;</div><div class="line">    // 论文中没有提到复制是顺序还是并发</div><div class="line">    // 如果顺序，latency是个问题</div><div class="line">    // 如果并发，为了HA和latency，&gt;N个节点会进行复制，造成空间浪费</div><div class="line">    if replicateTo(node) == ok &#123;</div><div class="line">        okN++</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // all read/write are performed on the first N healthy nodes from pref list</div><div class="line">    if okN == N &#123;</div><div class="line">        break</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Merkle树<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">node ring(A, B, C, D, E, A), W=3</div><div class="line">A crash</div><div class="line">那么本来应该复制到A的数据，会复制到D</div><div class="line">由于membership change是显示的，D知道这个数据是它临时替A代管的，它会写到临时存储，并携带hint(A) meta info，并定期检查A是否recover</div><div class="line">如果A ok，D会把本来该写到A的数据transfer给A，成功后，本地删除</div><div class="line"></div><div class="line">但，如果D永久crash，而A recover，那么这些hinted data，A就无从transfer了</div><div class="line">此时，通过Merkle进行检查、增量同步</div><div class="line">但它的问题是当有node进入、离开时，这个树要重新创建，在key多的时候非常费时，因此，它只能异步后台执行</div></pre></td></tr></table></figure></p>
<h3 id="IDCs"><a href="#IDCs" class="headerlink" title="IDCs"></a>IDCs</h3><p>只是在preference list上配一下，架构上并没有过多考虑<br>仍然是coordinator负责复制，首先本地机房，然后远程机房</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="http://jsensarma.com/blog/?p=55" target="_blank" rel="external">http://jsensarma.com/blog/?p=55</a><br><a href="http://jsensarma.com/blog/?p=64" target="_blank" rel="external">http://jsensarma.com/blog/?p=64</a><br><a href="https://timyang.net/data/dynamo-flawed-architecture-chinese/" target="_blank" rel="external">https://timyang.net/data/dynamo-flawed-architecture-chinese/</a><br><a href="https://news.ycombinator.com/item?id=915212" target="_blank" rel="external">https://news.ycombinator.com/item?id=915212</a><br><a href="http://www.allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf" target="_blank" rel="external">http://www.allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf</a></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://funkygao.github.io/2017/07/18/Dynamo-flaw/" data-id="cj5nhpoh2000nvb5b59idnq4o" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://funkygao.github.io/2017/07/18/Dynamo-flaw/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://funkygao.github.io/2017/07/18/Dynamo-flaw/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-MapReduce-A-major-step-backwards" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/07/17/MapReduce-A-major-step-backwards/">MapReduce - A major step backwards</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/07/17/MapReduce-A-major-step-backwards/">
            <time datetime="2017-07-17T06:19:27.000Z" itemprop="datePublished">2017-07-17</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/algorithm/">algorithm</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="Author"><a href="#Author" class="headerlink" title="Author"></a>Author</h2><p>都是数据库领域的权威</p>
<ul>
<li>Michael Stonebraker<br>美国工程院院士，冯诺依曼奖的获得者，第一届SIGMOD Edgar F. Codd创新奖的得主，曾担任Informix CTO<br>他在1992年提出对象关系数据库模型，在加州伯克利分校任计算机教授达25年，目前是麻省理工学院教授<br>是SQL Server/Sysbase奠基人，87年左右，Sybase联合了微软，共同开发SQL Server。1994年(7y)，两家公司合作终止<br>可以认为，Stonebraker教授是目前主流数据库的奠基人</li>
<li>David J. DeWitt<br>美国工程院院士<br>In 1995, he was named a Fellow of the ACM and received the ACM SIGMOD Innovations Award<br>In 2009, ACM recognized the seminal contributions of his Gamma parallel database system project with the ACM Software Systems Award<br>IEEE awarded him the 2009 IEEE Piore Award<br>He was also a Technical Fellow at Microsoft, leading the Microsoft Jim Gray Systems Lab at Madison, Wisconsin.</li>
</ul>
<h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>2008年1月，一个数据库专栏读者让作者表达一下对MapReduce(OSDI 2004)的看法而引出</p>
<h2 id="Viewpoint"><a href="#Viewpoint" class="headerlink" title="Viewpoint"></a>Viewpoint</h2><h3 id="MapReduce是历史后退"><a href="#MapReduce是历史后退" class="headerlink" title="MapReduce是历史后退"></a>MapReduce是历史后退</h3><p>从IBM IMS的第一个数据库系统(1968)到现在的40年，数据库领域学到了3个经验，而MapReduce把这些经验完全摒弃，仿佛回到了60年代DBMS还没出现的时候</p>
<ul>
<li>schema is good<br>防止garbage进入系统<br>MapReduce由于涉及到(k, v)，一定也是可以用schema表达的</li>
<li>要把schema从应用中decouple<br>存放在catalog里，而不是hard coding在应用层</li>
<li>high level query is good<br>70年代就充分讨论过应用通过SQL那样的语言访问DBMS好，还是更底层的语言<br>MapReduce就像是DBMS的汇编语言</li>
</ul>
<h3 id="MapReduce的实现糟糕"><a href="#MapReduce的实现糟糕" class="headerlink" title="MapReduce的实现糟糕"></a>MapReduce的实现糟糕</h3><p>他们应该好好学学25年来并行数据库方面的知识</p>
<h4 id="1-Index-vs-Brute-force"><a href="#1-Index-vs-Brute-force" class="headerlink" title="1. Index vs Brute force"></a>1. Index vs Brute force</h4><p>在非full scan场景下，index必不可少。此外，DBMS里还有query optimizer，而MapReduce里只能brute force full scan</p>
<p>MapReduce能提供自动的并行执行，但这些东西80年代就已经在学术界研究了，并在80年代末出现了类似Teradata那样的商业产品</p>
<h4 id="2-Record-Skew导致性能问题"><a href="#2-Record-Skew导致性能问题" class="headerlink" title="2. Record Skew导致性能问题"></a>2. Record Skew导致性能问题</h4><p>David J. DeWitt在并行数据库方向已经找到了解决方案，但MapReduce没有使用，好像skew问题根本不存在一样：<br>Map阶段，相同key的记录数量是不均衡的，这就导致Reduce阶段，有的reduce快、有的慢，最终Job的执行时间取决于最慢的那一个</p>
<h4 id="3-吞吐率和IO问题"><a href="#3-吞吐率和IO问题" class="headerlink" title="3. 吞吐率和IO问题"></a>3. 吞吐率和IO问题</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// map=1000 reduce=500</div><div class="line">1000个map实例，每个map进程都会创建500个本地文件</div><div class="line">reduce阶段，每个reduce都会到1000个map机器上PULL file</div><div class="line">这会导致每个map机器上500个文件进行大量的random IO</div></pre></td></tr></table></figure>
<p>而并行数据库，采用的是PUSH模型。而MapReduce要修改成PUSH模型是比较困难的，因为它的HA非常依赖它目前的PULL模型</p>
<h3 id="MapReduce并不新颖"><a href="#MapReduce并不新颖" class="headerlink" title="MapReduce并不新颖"></a>MapReduce并不新颖</h3><p>他们以为他们发现了一个解决大数据处理的新模式，实际上20年前就有了</p>
<p>“Application of Hash to Data Base Machine and Its Architecture”/1983，是第一个提出把大数据集切分成小数据集的<br>Teradata使用MapReduce同样的技术卖他们的商业产品已经20多年了</p>
<p>就算MapReduce允许用户自己写map/reduce来控制，80年代中期的POSTGRES系统就支持用户自定义函数</p>
<h3 id="缺少DBMS已经具备的功能"><a href="#缺少DBMS已经具备的功能" class="headerlink" title="缺少DBMS已经具备的功能"></a>缺少DBMS已经具备的功能</h3><ul>
<li>Bulk loader</li>
<li>Update<br>MapReduce is read-only</li>
<li>Transaction</li>
<li>Views<br>Hbase处已经提了</li>
<li>Integrity constraints<br>Schema处已经提了</li>
<li>Referential integrity<br>防止garbase进入系统</li>
</ul>
<h3 id="与DBMS工具不兼容"><a href="#与DBMS工具不兼容" class="headerlink" title="与DBMS工具不兼容"></a>与DBMS工具不兼容</h3><ul>
<li>BI tools</li>
<li>Data mining tools</li>
<li>Replication tools</li>
<li>ER modelling</li>
</ul>
<h3 id="SQL-on-hadoop"><a href="#SQL-on-hadoop" class="headerlink" title="SQL on hadoop"></a>SQL on hadoop</h3><p>作者已经发行类似Pig那样的系统</p>
<h3 id="Comments"><a href="#Comments" class="headerlink" title="Comments"></a>Comments</h3><p>作者好像觉得MR是用来替代DBMS的</p>
<ul>
<li>MapReduce与DBMS的定位不同，它不是OLTP<br>Index好，但cost也很高，在MR里index只会是成本而没有收益<br>用正确的工具解决不同的问题</li>
<li>Be a lover, not a fighter!</li>
<li>Google本身已经证明了它的scalability</li>
<li>With really large datasets and distributed sytems the RDBMS paradigms stop working<br>and that is where a system like Mapreduce is needed</li>
<li>数据库那些人的问题：什么东西都是数据库</li>
<li>作者应该再写个“Airplanes: A major step backward”</li>
</ul>
<h2 id="Jeff-Dean在ACM-of-communication上面的回馈"><a href="#Jeff-Dean在ACM-of-communication上面的回馈" class="headerlink" title="Jeff Dean在ACM of communication上面的回馈"></a>Jeff Dean在ACM of communication上面的回馈</h2>
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://funkygao.github.io/2017/07/17/MapReduce-A-major-step-backwards/" data-id="cj5nhpohs001ivb5bim9n1elr" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://funkygao.github.io/2017/07/17/MapReduce-A-major-step-backwards/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://funkygao.github.io/2017/07/17/MapReduce-A-major-step-backwards/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-conferences-and-journals" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/07/17/conferences-and-journals/">conferences and journals</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/07/17/conferences-and-journals/">
            <time datetime="2017-07-17T05:48:21.000Z" itemprop="datePublished">2017-07-17</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/misc/">misc</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>按照USnews的分类，Computer Science被分为四个大类：AI, Programming Language, System, Theory</p>
<p>PSU的CiteSeer(又名ResearchIndex)，有各个会议的影响因子，算是比较权威的</p>
<h2 id="System"><a href="#System" class="headerlink" title="System"></a>System</h2><p>包括OS、Architecture、Network、Database等</p>
<h3 id="OS"><a href="#OS" class="headerlink" title="OS"></a>OS</h3><p>OSDI、SOSP，这两个是OS最好的会议，每两年开一次，轮流开</p>
<ul>
<li>SOSP: The ACM Symposium on Operating Systems Principles<br>由ACM下属的SIGOPS(special interest group on operation system)于1967年创办，每届收录20篇<br>GFS就是发表在SOSP 2003的, Dynamo是SOSP 2007</li>
<li>OSDI: USENIX Symposium on Operating Systems Design and Implementation<br>USENIX是一个于1975年成立的Advanced Computing Systems Association<br>OSDI是USENIX 1994创办的，每届会议举行3天，每届收录27篇文章，每个小方向3篇<br>MapReduce是发表在OSDI 2004的</li>
</ul>
<h3 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h3><ul>
<li>ISCA</li>
<li>HPCA</li>
<li>MICRO</li>
</ul>
<h3 id="Database"><a href="#Database" class="headerlink" title="Database"></a>Database</h3><p>数据库方向的三大顶级会议，SIGMOD和VLDB算是公认第一档次</p>
<ul>
<li>ACM SIGMOD</li>
<li>VLDB:International Conference on Very Large Data Bases</li>
<li>ICDE:International Conference on Data Engineering</li>
</ul>
<h3 id="Security"><a href="#Security" class="headerlink" title="Security"></a>Security</h3><ul>
<li>IEEE Security and Privacy</li>
<li>CCS: ACM Computer and Communications Security</li>
<li>NDSS (Network and Distributed Systems Security)</li>
</ul>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="http://blog.sina.com.cn/s/blog_b3b900710102whvj.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_b3b900710102whvj.html</a><br><a href="http://sigops.org/sosp/sosp15/current/index.html" target="_blank" rel="external">http://sigops.org/sosp/sosp15/current/index.html</a></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://funkygao.github.io/2017/07/17/conferences-and-journals/" data-id="cj5nhpoio0034vb5bfhulwlfs" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://funkygao.github.io/2017/07/17/conferences-and-journals/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://funkygao.github.io/2017/07/17/conferences-and-journals/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-committee" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/07/17/committee/">committee</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/07/17/committee/">
            <time datetime="2017-07-17T05:48:06.000Z" itemprop="datePublished">2017-07-17</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/misc/">misc</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p><img src="https://github.com/funkygao/blogassets/blob/master/img/committee.png?raw=true" alt="技术委员会"></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://funkygao.github.io/2017/07/17/committee/" data-id="cj5nhpoio0032vb5bvq6cvk8q" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://funkygao.github.io/2017/07/17/committee/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://funkygao.github.io/2017/07/17/committee/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-LINQ" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/07/14/LINQ/">LINQ</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/07/14/LINQ/">
            <time datetime="2017-07-14T01:45:45.000Z" itemprop="datePublished">2017-07-14</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/architecture/">architecture</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>Language Integrated Query，一个C#的语言特性，基本思想是在语言层面增加了query的能力</p>
<p>在通过GraphQL中，应该可以发挥它的能力，来进行聚合、过滤、排序等</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://funkygao.github.io/2017/07/14/LINQ/" data-id="cj5nhpohk0018vb5bja2tafee" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://funkygao.github.io/2017/07/14/LINQ/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://funkygao.github.io/2017/07/14/LINQ/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-bigdata" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/07/14/bigdata/">bigdata story</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/07/14/bigdata/">
            <time datetime="2017-07-14T00:06:16.000Z" itemprop="datePublished">2017-07-14</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/cloud/">cloud</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>大数据，主要是因为Google的Google File System(2003)， MapReduce(OSDI 2004)，BigTable(2006)三篇论文<br>GFS论文是最经典的，后面google的很多论文都遮遮掩掩的<br>Chubby(2006)<br>Dremal(2010)<br>Borg(2015)</p>
<p>微软在bing项目上的投入，使得微软掌握了大规模data center的建设管理能力，掌握了A/B testing平台，学会了大规模数据分析能力，其中一些成为了Azure的基础，它使得微软顺利从一家软件公司过渡到了云计算公司。<br>微软内部支撑大数据分析的平台Cosmos是狠狠的抄袭了Google的File system却很大程度上摒弃了MapReduce这个框架<br>所谓MapReduce的意思是任何的事情只要都严格遵循Map Shuffle Reduce三个阶段就好。其中Shuffle是系统自己提供的而Map和Reduce则用户需要写代码。Map是一个per record的操作。任何两个record之间都相互独立。Reduce是个per key的操作，相同key的所有record都在一起被同时操作，不同的key在不同的group下面，可以独立运行<br>Map是分类(categorize)操作，Reduce是aggregate</p>
<p>To draw an analogy to SQL, map is like the group-by clause of an aggregate query. Reduce is analogous to the aggregate function (e.g., average) that is computed over all the rows with the same group-by attribute.</p>
<p>Flume Java本质上来说还是MapReduce，但是它采取了一种delayed execution的方式，把所有相关的操作先存成一个execution DAG,然后一口气执行。<br>这和C#里的LINQ差不多。这种方式就产生了很多optimization的机会了。具体来说大的有两个:</p>
<ul>
<li>一个是怎么样把若干个Map或者Reduce整成一个</li>
<li>一个是怎么样把一系列的operation整成一个MapReduce job</li>
</ul>
<p>Hadoop三大批发商分别是Cloudera，Hortonworks以及MapR。<br>MapR(印度人CTO是Google GFS项目组，后用C++写了自己的HDFS)、Cloudera(源于BerkeleyDB卖给Oracle)都成立于2009年，Hortonworks(源于Yahoo Hadoop分拆) 2011，目前Cloudera一家独大<br>Hortonworks基本上就是Yahoo里的Hadoop团队减去被Cloudera挖走的Doug Cutting, Hadoop的创始人。这个团队的人做了不少东西，最初的HDFS和Hadoop MapReduce, ZooKeeper,以及Pig Latin。<br>MapR的印度人CTO，目前已经跳槽到了Uber</p>
<p>Hortonworks本来是一个发明了Pig的公司。Pig是它们的亲儿子。现在他们作为一个新成立的公司，不像Cloudera或者MapR那样另起炉灶，却决定投入HIVE的怀抱，要把干儿子给捧起来<br>Pig发表在SIGMOD2008，之后Hive也出来了<br>时至今日，我们必须说Pig是被大部分人放弃了：原来做Pig的跑去了Hortonworks，改行做Hive了<br>HIVE已经事实上成为了Hadoop平台上SQL和类SQL的标杆和事实的标准。</p>
<p>2008年Hadoop的一次会议，facebook的2个印度人讲了他们hackathon的项目Hive，他们说SQL的SELECT FROM应该是FROM SELECT<br>2010年Hive论文发表，直到2014年那2个印度人一直在Hive PMC，后来出来创业大数据公司<br>后来，做Pig的人看上了Hive，Hortonworks把自己人塞进PMC，现在那2个印度人已经除名了，Hive基本上是Hortonworks和Cloudera的天下，Cloudera做企业需要的安全方面东西，Hortonworks做性能提升<br>于是，Pig的人成了Hive主力，做Hive的人跑光了</p>
<p>Dynamo: A flawed architecture<br><a href="http://jsensarma.com/blog/?p=55" target="_blank" rel="external">http://jsensarma.com/blog/?p=55</a></p>
<p>Hbase开始的时候是一个叫Powerset的公司，这个公司是做自然语言搜索的。公司为了能够实现高效率的数据处理，做了HBase。2008年的时候这个公司被卖给了微软</p>
<p>VLDB(Very Large Data Base), 世界数据库业界三大会议之一；另外两个是ICDE和sigmod，另外还有KDD。<br>在数据库领域里面，通常SIGMOD和VLDB算是公认第一档次，ICDE则是给牛人接纳那些被SIGMOD VLDB抛弃的论文的收容所，勉强1.5吧，而且有日渐没落的趋势。<br>CIDR在数据库研究领域是个奇葩的会议，不能说好不能说不好。因为是图灵机得主Michael Stonebraker开的，给大家提供个自娱自乐的场所。所以很多牛人买账，常常也有不错的论文。但是更多的感觉是未完成的作品。</p>
<p>Dremal出来没多久，开源社区，尤其是Hadoop的批发商们都纷纷雀跃而起。Cloudera开始做Impala，MapR则做了Drill，Hortonworks说我们干脆直接improve HIVE好了，所以就有了包括Apache Tez在内的effort<br>Dremal的存储是需要做一次ETL这样的工作，把其他的数据通过转化成为它自己的column store的格式之后才能高效率的查询的。</p>
<p>Dremal出来后，Cloudera 2012年做出了Impala，MapR搞了个Drill，Hortonworks也许最忽悠也许最实际，说我们只需要改善 Hive就好</p>
<p>Spark是迄今为止由学校主导的最为成功的开源大数据项目<br>UCBerkeley作为一个传统上非常有名的系统学校，它曾经出过的系统都有一个非常明确的特点，可用性非常高</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://funkygao.github.io/2017/07/14/bigdata/" data-id="cj5nhpoij002svb5byf41igd2" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://funkygao.github.io/2017/07/14/bigdata/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://funkygao.github.io/2017/07/14/bigdata/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <nav id="page-nav">
        <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
</section>
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">recent</h3>
        <div class="widget">
            <ul id="recent-post" class="no-thumbnail">
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/07/25/GFS/" class="title">GFS evolution and BigTable</a></p>
                            <p class="item-date"><time datetime="2017-07-25T06:39:34.000Z" itemprop="datePublished">2017-07-25</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/07/19/replication/" class="title">replication models</a></p>
                            <p class="item-date"><time datetime="2017-07-19T11:12:26.000Z" itemprop="datePublished">2017-07-19</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/07/19/Google-container-evolution/" class="title">Google container evolution</a></p>
                            <p class="item-date"><time datetime="2017-07-19T01:45:30.000Z" itemprop="datePublished">2017-07-19</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/07/18/Ceph/" class="title">Ceph Internals</a></p>
                            <p class="item-date"><time datetime="2017-07-18T07:27:20.000Z" itemprop="datePublished">2017-07-18</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/07/18/Dynamo-flaw/" class="title">Dynamo - A flawed architecture</a></p>
                            <p class="item-date"><time datetime="2017-07-18T00:35:12.000Z" itemprop="datePublished">2017-07-18</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a><span class="archive-list-count">36</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">42</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tags</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/PubSub/">PubSub</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/">algorithm</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/architecture/">architecture</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cloud/">cloud</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/database/">database</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hacking/">hacking</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/">misc</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/protocol/">protocol</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/storage/">storage</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/一致性/">一致性</a><span class="tag-list-count">9</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tag cloud</h3>
        <div class="widget tagcloud">
            <a href="/tags/PubSub/" style="font-size: 18.75px;">PubSub</a> <a href="/tags/algorithm/" style="font-size: 16.25px;">algorithm</a> <a href="/tags/architecture/" style="font-size: 13.75px;">architecture</a> <a href="/tags/cloud/" style="font-size: 13.75px;">cloud</a> <a href="/tags/database/" style="font-size: 20px;">database</a> <a href="/tags/hacking/" style="font-size: 10px;">hacking</a> <a href="/tags/misc/" style="font-size: 12.5px;">misc</a> <a href="/tags/protocol/" style="font-size: 11.25px;">protocol</a> <a href="/tags/storage/" style="font-size: 17.5px;">storage</a> <a href="/tags/一致性/" style="font-size: 15px;">一致性</a>
        </div>
    </div>

    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            <div class="x2 x2-move">
                <span id="busuanzi_container_page_pv">PV: <span id="busuanzi_value_page_pv"></span></span>
                    <span id="busuanzi_container_site_pv">Site: <span id="busuanzi_value_site_pv"></span></span>
                <span id="busuanzi_container_site_uv">UV: <span id="busuanzi_value_site_uv"></span></span>
            </div>
        </div>
    </div>
</footer>

<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

        
    
    <script>
    var disqus_config = function () {
        
        this.page.identifier = 'undefined';
    };
    (function() { 
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'hexo-theme-icarus' + '.disqus.com/count.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>